<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1251">

<title>“ехнологические вопросы крупных внедрений</title>
<link href="./tran-isolation/style.css" rel="stylesheet" type="text/css">
<link href="./tran-isolation/style2.css" rel="stylesheet" type="text/css">
<link href="./tran-isolation/content.css" rel="stylesheet" type="text/css">
<style type="text/css">
<!--
.style2 {
	color: #FF0000;
	font-size: 10px;
}
.style1 {
	color: #FFFFFF;
	font-weight: bold;
}
.style3 {
	color: #C10000;
	font-weight: bold;
	line-height: 30px;
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 9px;
}

h3.base01 {color:#601000}

body {
    margin: 0px;
}

-->
</style>
<style type="text/css"></style><style type="text/css">#lleo_dialog, #lleo_dialog * {
    margin: 0 !important;
	padding: 0 !important;
	background: none !important;
	border: none 0 !important;
	position: static !important;
	vertical-align: baseline !important;
	font: normal 13px Arial, Helvetica !important;
	line-height: 15px !important;
	color: #000 !important;
	overflow: visible !important;
	width: auto !important;
	height: auto !important;
	float: none !important;
	visibility: visible !important;
	text-align: left !important;
	border-collapse: separate !important;
	border-spacing: 2px !important;
}

#lleo_dialog iframe {
	height: 0 !important;
	width: 0 !important;
}

#lleo_dialog {
    position: absolute !important;
    background: #fff !important;
    border: solid 1px #ccc !important;
    padding: 7px 0 0 !important;
    left: -999px;
    top: -999px;
	/*max-width: 450px !important;*/
    width: 440px !important;
    overflow: hidden;
    display: block !important;
    z-index: 999999999 !important;
    opacity: 0 !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18) !important;
	-moz-border-radius: 3px !important;
	-webkit-border-radius: 3px !important;
	border-radius: 3px !important;
}
#lleo_dialog.lleo_show {
    opacity: 1 !important;
    -webkit-transition: opacity 0.3s !important;
}
#lleo_dialog input::-webkit-input-placeholder {
    color: #aaa !important;
}
#lleo_dialog .lleo_has_pic #lleo_word {
	margin-right: 80px !important;
}
#lleo_dialog #lleo_translationsCopntainer1 {
	position: relative !important;
}
#lleo_dialog #lleo_translationsCopntainer2 {
	padding: 7px 0 0 !important;
	vertical-align: middle !important;
}
#lleo_dialog #lleo_word {
    color: #000 !important;
    margin: 0 5px 2px 0 !important;
    /*float: left !important;*/
}
#lleo_dialog .lleo_has_sound #lleo_word {
    margin-left: 17px !important;
}
#lleo_dialog #lleo_text {
    font-weight: bold !important;
    color: #d56e00 !important;
    text-decoration: none !important;
    cursor: default !important;
}
#lleo_dialog #lleo_text.lleo_known {
    cursor: pointer !important;
    text-decoration: underline !important;
}
#lleo_dialog #lleo_closeBtn {
    position: absolute !important;
    right: 6px !important;
    top: 5px !important;
    line-height: 1px !important;
    text-decoration: none !important;
    font-weight: bold !important;
    font-size: 0 !important;
    color: #aaa !important;
    display: block !important;
    padding: 2px !important;
	z-index: 9999999999 !important;
	width: 7px !important;
	height: 7px !important;
	padding: 0  !important;
	margin: 0   !important;
}

#lleo_dialog #lleo_optionsBtn {
    position: absolute !important;
    right: 1px !important;
    top: 12px !important;
    line-height: 1px !important;
    text-decoration: none !important;
    font-weight: bold !important;
    font-size: 13px !important;
    color: #aaa !important;
    padding: 2px !important;
	display: none;
}
#lleo_dialog #lleo_optionsBtn img{
	width: 12px !important;
	height: 12px !important;
}
#lleo_dialog #lleo_sound {
    float: left !important;
    width: 16px !important;
    height: 16px !important;
    margin-left: 12px !important;
    background: 0 0 no-repeat !important;
    cursor: pointer !important;
    display: none !important;
}
#lleo_dialog .lleo_has_sound #lleo_sound {
    display: block !important;
}
#lleo_dialog #lleo_picOuter {
    position: absolute !important;
    float: right !important;
    right: 29px;
    top: 0;
    display: none !important;
    z-index: 9 !important;
}
#lleo_dialog .lleo_has_pic #lleo_picOuter {
    display: block !important;
}
#lleo_dialog #lleo_picOuter:hover {
    z-index: 11 !important;
}
#lleo_dialog #lleo_pic,
#lleo_dialog #lleo_picBig {
    position: absolute !important;
    top: 0 !important;
    right: 0 !important;
    border: solid 2px #fff !important;
    -moz-border-radius: 2px !important;
	-webkit-border-radius: 2px !important;
	border-radius: 2px !important;
    z-index: 1 !important;
}
#lleo_dialog #lleo_pic {
	position: relative !important;
    border: none !important;
	width: 34px !important;
}
#lleo_dialog #lleo_picBig {
    box-shadow: -1px 2px 4px rgba(0,0,0,0.3);
    z-index: 2 !important;
    opacity: 0 !important;
    visibility: hidden !important;
}
#lleo_dialog #lleo_picOuter:hover #lleo_picBig {
    visibility: visible !important;
    opacity: 1 !important;
    -webkit-transition: opacity 0.3s !important;
    -webkit-transition-delay: 0.3s !important;
}
#lleo_dialog #lleo_transcription {
    color: #486D85 !important;
    margin: 0 0 4px 29px !important;
    color: #aaaaaa !important;
}
#lleo_dialog .lleo_no_trans {
    color: #aaa !important;
}






#lleo_dialog .ll-translation-counter {
	float: right !important;
    font-size: 11px !important;
    color: #aaa !important;
    padding: 2px 2px 1px 10px !important;
}

#lleo_dialog .ll-translation-text {
	float: left !important;
	width: 80% !important;
}

#lleo_dialog #lleo_trans a {
    color: #3F669F !important;
    padding: 1px 4px !important;
    text-decoration: none !important;
    text-overflow: ellipsis !important;
    overflow: hidden !important;
}

#lleo_dialog .ll-translation-item {
	width: 100% !important;
	float: left !important;
	padding:1px 4px;
	color: #3F669F !important;
	padding: 3px !important;
	border: solid 1px white !important;
	-moz-border-radius: 2px !important;
	-webkit-border-radius: 2px !important;
	border-radius: 2px !important;
}

#lleo_dialog .ll-translation-item:hover {
	border: solid 1px #9FC2C9 !important;
    background: #EDF4F6 !important;
	cursor: pointer !important;
}

#lleo_dialog .ll-translation-marker {
	margin: 0px 5px 2px 2px !important;
}





#lleo_dialog #lleo_icons {
    margin: 10px 0 7px !important;
    color: #aaa !important;
    line-height: 20px !important;
    font-size: 11px !important;
    clear: both !important;
    padding-left: 16px !important;
}
#lleo_icons a {
    display: inline-block !important;
    width: 16px !important;
    height: 16px !important;
    margin: 0 0 -2px 3px !important;
    text-decoration: none !important;
    background: 0 0 no-repeat !important;
    opacity: 0.5 !important;
}
#lleo_icons a:hover {
    opacity: 1 !important;
}
#lleo_icons a.lleo_google     {background-position:-34px 0 !important;}
#lleo_icons a.lleo_multitran  {background-position:-64px 0 !important;}
#lleo_icons a.lleo_lingvo     {background-position:-51px 0 !important; width: 12px !important;}
#lleo_icons a.lleo_dict       {background-position:-17px 0 !important;}
#lleo_icons a.lleo_linguee    {background-position:-81px 0 !important;}
#lleo_icons a.lleo_michaelis  {background-position:-98px 0 !important;}




#lleo_dialog #lleo_contextContainer {
    margin: 0 !important;
    padding: 3px 15px 3px 10px !important;
    background: -webkit-gradient(linear, left top, left bottom, from(#fff), to(#eee)) !important;
    border-bottom: solid 1px #ddd !important;
    border-top-left-radius: 3px !important;
    border-top-right-radius: 3px !important;
    display: none !important;
    overflow: hidden !important;
}
#lleo_dialog .lleo_has_context #lleo_contextContainer {
    display: block !important;
}
#lleo_dialog #lleo_context {
    color: #444 !important;
    text-shadow: 1px 1px 0 #f4f4f4 !important;
    line-height: 12px !important;
    font-size: 11px !important;
    margin-left: 2px !important;
}
#lleo_dialog #lleo_context b {
    line-height: 12px !important;
    color: #000 !important;
    font-weight: bold !important;
    font-size: 11px !important;
}
#lleo_dialog #lleo_gBrand {
    color: #aaa !important;
    font-size: 10px !important;
    /*padding-right: 52px !important;*/
    padding-bottom: 14px !important;
    margin: -3px 4px 0 4px !important;
    background: left bottom no-repeat !important;
    display: inline-block !important;
    float: right !important;
}
#lleo_dialog #lleo_gBrand.hidden {
    display: none !important;
}
#lleo_dialog #lleo_translateContextLink {
    color: #444 !important;
    text-shadow: 1px 1px 0 #f4f4f4 !important;
    background: -webkit-gradient(linear, left top, left bottom, from(#f4f4f4), to(#ddd)) !important;
    border: solid 1px !important;
    box-shadow: 1px 1px 0 #f6f6f6 !important;
    border-color: #999 #aaa #aaa #999 !important;
    -moz-border-radius: 2px !important;
	-webkit-border-radius: 2px !important;
	border-radius: 2px !important;
    padding: 0 3px !important;
    font-size: 11px !important;
    text-decoration: none !important;
    margin: 1px 5px 0 !important;
    display: inline-block !important;
    white-space: nowrap !important;
}
#lleo_dialog #lleo_translateContextLink:hover {
    background: #f8f8f8 !important;
}

#lleo_dialog #lleo_setTransForm {
    display: block !important;
    margin-top: 3px !important;
    padding-top: 5px !important;
    /* Set position and background because the form might be overlapped by an image when no translations */
    position: relative !important;
    background: #fff !important;
    z-index: 10 !important;
    padding-bottom: 10px !important;
    padding-left: 16px !important;
}
#lleo_dialog .lleo-custom-translation {
    padding: 4px 5px !important;
    border: solid 1px #ddd !important;
    -moz-border-radius: 2px !important;
	-webkit-border-radius: 2px !important;
	border-radius: 2px !important;
    width: 90% !important;
    min-width: 270px !important;
    background: -webkit-gradient(linear, 0 0, 0 20, from(#f1f1f1), to(#fff)) !important;
	font: normal 13px Arial, Helvetica !important;
	line-height: 15px !important;
}
#lleo_dialog .lleo-custom-translation:hover {
    border: solid 1px #aaa !important;
}
#lleo_dialog .lleo-custom-translation:focus {
    background: #FFFEC9 !important;
}

#lleo_dialog *.hidden {
    display: none !important;
}

#lleo_dialog .infinitive{
    color: #D56E00 !important;
    text-decoration: none;
    border-bottom: 1px dotted #D56E00 !important;
}
#lleo_dialog .infinitive:hover{
    border: none !important;
}


#lleo_dialog #lleo_trans{
    zoom: 1;
    border-top: 1px solid #eeeeee !important;
    margin: 10px 0 0 !important;
    padding: 5px 30px 0 14px !important;
}

#lleo_dialog .lleo_clearfix {
	display: block !important;
	clear: both !important;
	visibility: hidden !important;
	height: 0 !important;
	font-size: 0 !important;
}

#lleo_dialog #lleo_markBlock {
    background: #eeeeee !important;
	cursor: pointer !important;
	border-bottom-left-radius: 3px !important;
	border-bottom-right-radius: 3px !important;
	border-collapse: separate !important;
	border-spacing: 2px !important;
}

#lleo_dialog #lleo_markBlock img{
	width: 14px !important;
	height: 14px !important;
}

#lleo_dialog #lleo_markBlock .icon-cell {
	padding: 5px 2px 5px 16px !important;
	height: 17px !important;
}

#lleo_dialog #lleo_markBlock .wide-cell {
	width: 100% !important;
}

#lleo_dialog #lleo_markBlock .text-cell {
	color: #999999 !important;
    font: normal 13px Arial, Helvetica !important;
    text-shadow: 0 1px #fff !important;
}

#lleo_dialog #lleo_markBlock td {
	vertical-align: middle !important;
	border-collapse: separate !important;
	border-spacing: 2px !important;
}


#lleo_dialog #lleo_picOuter table{
    width: 44px !important;
    position: absolute !important;
    right: 0 !important;
    vertical-align: middle !important;
}

#lleo_dialog #lleo_picOuter td{
    width: 38px !important;
    height: 38px !important;
    border: 1px solid #eeeeee !important;
    vertical-align: middle !important;
    text-align: center !important;
}

#lleo_dialog #lleo_picOuter td div {
	height: 38px !important;
	overflow: hidden !important;
}</style><style type="text/css">
.ll-content-notification *{
	letter-spacing: normal !important;
	margin: 0 !important;
    padding: 0 !important;
	background: none !important;
	border: 0 !important;
	float: none !important;
	text-align: left !important;
	text-decoration: none !important;
    font: normal 15px 'Lucida Grande', 'Lucida Sans Unicode', Lucida, Arial, Helvetica, sans-serif !important;
}


.ll-content-notification {
    vertical-align: baseline !important;
    color: #000 !important;
    overflow: visible !important;
    visibility: visible !important;
    margin: 0 !important;
    padding: 0 !important;
    position: fixed !important;
    background: #fff !important;
    border: solid 1px #AAA !important;
	/*
    left: -999px;
    top: -999px;
	*/
    width: auto;
    /* width: 300px !important; */
    display: block;
    z-index: 999999999 !important;
    -webkit-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18) !important;
    -moz-box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18) !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18) !important;
    -webkit-border-radius: 3px !important;
    -moz-border-radius: 3px !important;
    border-radius: 3px !important;
    overflow: hidden !important;
    /* opacity: 0 !important; */
    transition: opacity 0.8s !important;
    -moz-transition: opacity 0.8s !important; /* Firefox 4 */
    -webkit-transition: opacity 0.8s !important; /* Safari and Chrome */
    -o-transition: opacity 0.8s !important; /* Opera */
    cursor: default !important;
}

.ll-content-notification-shown {
    opacity: 1 !important;
    transition: opacity 0.8s !important;
    -moz-transition: opacity 0.8s !important; /* Firefox 4 */
    -webkit-transition: opacity 0.8s !important; /* Safari and Chrome */
    -o-transition: opacity 0.8s !important; /* Opera */
}

.ll-content-notification-header {
	border: 0 !important;
	margin: 0 !important;
    background: url(data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAABCAIAAABsYngUAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAABJJREFUGFdjePHmCxw9e/UZjgAVYhYtk8xZqAAAAABJRU5ErkJggg==) !important;
    border-bottom: solid 1px #CCC !important;
    padding: 1px 4px !important;
	min-height: 18px !important;
	width: 100% !important;
	-webkit-border-top-left-radius: 3px !important;
    -webkit-border-top-right-radius: 3px !important;
    -moz-border-radius-topleft: 3px !important;
    -moz-border-radius-topright: 3px !important;
    border-top-left-radius: 3px !important;
    border-top-right-radius: 3px !important;
	border-collapse: collapse !important;
	border-spacing: 0 !important;
}

.ll-content-notification-header-pic {
	border: 0 !important;
	margin: 0 !important;
	padding: 3px 0 0 3px !important;
	width: 20px !important;
	vertical-align: top !important;
	line-height: 1px !important;
}

.ll-content-notification-header-pic img{
	border: 0 !important;
	padding: 0 !important;
	margin: 0 !important;
	line-height: 1px !important;
}


.ll-content-notification-header-caption {
    font: normal 13px 'Lucida Grande', 'Lucida Sans Unicode', Lucida, Arial, Helvetica, sans-serif !important;
	font-weight: bold !important;
    line-height: 15px !important;
    color: #555 !important;
    float: left !important;
    text-shadow: none !important;
    letter-spacing: normal !important;
	white-space: normal !important;
	padding: 3px !important;
	margin: 0 !important;
}

.ll-content-notification-header-close {
    width: 15px !important;
	vertical-align: top !important;
	text-align: right !important;
	padding: 6px 5px 0 0 !important;
	margin: 0 !important;
	line-height: 1px !important;
}

.ll-content-notification-header-close img {
	border: 0 !important;
    width: 7px !important;
    height: 7px !important;
    margin: 0 !important;
	padding: 0 !important;
}

.ll-content-notification-content {
    margin: 0 !important;
    padding: 8px !important;
    float: left !important;
    overflow: hidden !important;
    width: auto !important;
}

.ll-content-notification-content-logo {
    float: left !important;
	height: 48px !important;
	width: 48px !important;
}

.ll-content-notification-content-main {
    margin-left: 60px !important;
    overflow: hidden !important;
    padding: 0 0 2px 0 !important;
    color: #333 !important;
    text-align: left !important;
    text-shadow: none !important;
    letter-spacing: normal !important;
    font: normal 13px 'Lucida Grande', 'Lucida Sans Unicode', Lucida, Arial, Helvetica, sans-serif !important;
    line-height: 15px !important;
    width: auto !important;
}

.ll-content-notification-content-header {
	text-align: left !important;
	text-decoration: none !important;
    font: bold 15px 'Lucida Grande', 'Lucida Sans Unicode', Lucida, Arial, Helvetica, sans-serif !important;
    line-height: 19px !important;
    margin: 0 0 4px 0 !important;
    padding: 0 !important;
    border: 0 !important;
    color: #333 !important;
    text-shadow: none !important;
    letter-spacing: normal !important;
    display: block !important;
    top: 0 !important;
    left: 0 !important;
}

.ll-content-notification-word {
    color: #d56e00 !important;
    font-weight: bold !important;
    font-size: 14px !important;
}
</style></head>



<body leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<script src="./tran-isolation/formatMess.js" type="text/javascript"></script>

<p></p>

<h1>
	<img src="./tran-isolation/book_open.gif" width="16" height="16" alt="" border="0">
	Ѕлокировки данных в 1—:ѕредпри€тии 8
</h1>
<h3>јвтор: Ѕелоусов ѕавел (јльтер Ћого, ћосква)</h3>

<div class="bord">
	<h3 style="border-bottom: dashed 1px #dcdcdc; color:#696969; margin-top: 0px;"> раткое содержание:</h3>
	1. „то такое блокировка данных и зачем она нужна<br>2. ќбъектные блокировки<br>3. “ранзакционные блокировки<br>4. јвтоматические транзакционные блокировки<br>5. ”правл€емые транзакционные блокировки<br>6. ѕеревод конфигурации в режим управл€емых блокировок
</div>

<div class="bord" id="copytextbody">
	<br>
<div align="right">
<address>
ƒанна€ стать€ €вл€етс€ фрагментом книги ѕ.—.Ѕелоусов, ј.¬.ќстроверх "1—:ѕредпри€тие: от 8.0 к 8.1".<br>
ƒата выхода книги: но€брь 2007.<span></span></address>
</div>
<h1 align="center">Ѕлокировки данных в 1—:ѕредпри€тии 8</h1>
<p>
ѕри одновременной работе нескольких пользователей с одной и той же информационной базой периодически возникают ситуации, когда два или более пользователей пытаютс€ не только одновременно прочитать одни те же данные, но и внести в них какие-то изменени€. ќчевидно, что если в таких случа€х не предусмотреть возможности подключени€ специальных механизмов системы, то могут возникнуть проблемы, св€занные с целостностью и достоверностью данных, хранимых в информационной базе.
</p>
<br>
<p>
ќписанию возникающих проблем, а также путей их решени€ в системе 1—:ѕредпри€ти€ 8.1 и посв€щена данна€ стать€.
</p>
<h2 align="center">„то такое блокировка </h2>
<p>
ѕрежде чем начать изучение механизмов 1—:ѕредпри€ти€, обеспечивающих конкурентный доступ пользователей к данным, познакомимс€ с тем, что такое блокировки, когда они возникают и можно ли обойтись без блокировок.
</p>
<br>
<p>
¬ общем случае <span class="style4"><em><font color="#ff6600">блокировка</font></em></span> - это информаци€ о том, что данный ресурс захвачен Ђкем-тої, дл€ выполнени€ какого-то действи€.
</p>
<br>
<p>
–ассмотрим простой пример. ѕродавец продает €блоки. “ак получилось, что продавец очень рассе€н и ему приходитс€ абсолютно все записывать. ѕо этой же причине все €блоки у него пронумерованны.
</p>
<br>
<p>
ѕришел покупатель »ванов и ему понравилось €блоко є4. ќн хочет его купить. »ванов достает кошелек и отсчитывает деньги (рис. 1).
</p>
<br>
<div style="text-align: center">
<img src="./tran-isolation/pic_01.jpg" alt="–ис. 1. »ванов хочет купить €блоко є4" title="–ис. 1. »ванов хочет купить €блоко є4" width="575" height="355">
</div>
<p align="center">
<span class="style9"><strong><font color="#993366">–ис. 1.</font></strong></span> »ванов хочет купить €блоко є4
</p>
<p align="center">
&nbsp;
</p>
<p>
“ем временем, продавец делает запись в своей книге: Ђяблоко є4 - продано »вановуї. Ёта запись и есть блокировка (рис. 2).&nbsp;
</p>
<br>
<div style="text-align: center">
<img src="./tran-isolation/pic_02.jpg" alt="–ис. 2. ѕродавец Ђзаблокировалї €блоко є4" title="–ис. 2. ѕродавец Ђзаблокировалї €блоко є4" width="575" height="355">
</div>
<p align="center">
<span class="style9"><font color="#993366"><strong>–ис. 2.</strong></font></span> ѕродавец Ђзаблокировалї €блоко є4
</p>
<p align="center">
&nbsp;
</p>
<p>
ќбратите внимание, что на самом деле €блоко все еще находитс€ у продавца, »ванов его не купил. ћожет быть и не сможет купить (например окажетс€, что не хватает денег). Ќо у продавца уже записано, что это €блоко нельз€ предлагать другим покупател€м до тех пор, пока »ванов не завершит процесс покупки. Ётот процесс, состо€щий из нескольких взаимосв€занных действий (выбор €блока, отсчитывание денег, передача денег продавцу, передача €блока покупателю) называетс€ транзакцией. Ѕлокировка должна быть установлена в момент выбора »вановым €блока є4 и сн€та после завершени€ транзакции покупки.
</p>
<br>
<p>
“ем временем подходит ѕетров и тоже хочет купить €блоко. ќн сможет купить любое €блоко, кроме €блока є4 (рис. 3).
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/pic_03.jpg" alt="–ис. 3. ѕетров сможет купить любое €блоко, кроме €блока є4" title="–ис. 3. ѕетров сможет купить любое €блоко, кроме €блока є4" width="575" height="355">
</p>
<p align="center">
<span class="style9"><font color="#993366"><strong>–ис. 3.</strong></font></span> ѕетров сможет купить любое €блоко, кроме €блока є4
</p>
<br>
<p>
“аким образом смысл блокировки с том, чтобы запретить некоторые действи€ над общим ресурсом на некоторое ограниченное врем€. ¬ данном случае ѕетрову запрещено выбирать €блоко є4 до тех пор, пока »ванов не завершил свою транзакцию покупки. “о есть, ѕетров находитс€ в состо€нии ожидани€ на блокировке.
</p>
<br>
<p>
»з приведенного примера пон€тно, что блокировки - это необходимый механизм при конкурентном доступе к общим ресурсам. ¬ самом деле, что бы было, если бы продавец не записал в своей книге, что €блоко из четвертой €чейки нельз€ предлагать другим покупател€м? —корее всего произошел бы конфликт между »вановым и ѕетровым, возможно при этом Ђдосталосьї бы и продавцу. ¬ любом случае, если запись в книге продавца отсутствует, исход данной ситуации становитс€ непредсказуемым. Ќеизвестно, кому достанетс€ это €блоко, неизвестно у кого окажутс€ деньги, которые »ванов за него отдал и так далее.
</p>
<br>
<p>
≈сли же блокировка на €блоко є4 установлена, то это гарантирует однозначный исход: »ванов гарантированно сможет купить €блоко, если у него хватит денег. ≈сли же он откажетс€ от покупки, то только в этом случае €блоко из 4 €чейки сможет купить ѕетров.
</p>
<br>
<p>
—ледует понимать, что в силу различных причин блокировки могут быть как Ђхорошимиї (необходимыми), так и Ђплохимиї (избыточными).
</p>
<br>
<p>
–ассмотрим еще один вариант развити€ событий, который по€сн€ет откуда берутс€ Ђплохиеї блокировки.
</p>
<br>
<p>
ѕокупатель »ванов хочет купить одно €блоко. ќн перебирает все €блоки из €щика по одному, выбира€, какое лучше. ѕри этом продавец записывает в своей книге все €блоки, которые понравились »ванову (рис. 4).
</p>
<br>
<div style="text-align: center">
<img src="./tran-isolation/pic_04.jpg" alt="–ис. 4. ѕродавец блокирует все €блоки, которые нрав€тс€ »ванову" title="–ис. 4. ѕродавец блокирует все €блоки, которые нрав€тс€ »ванову" width="575" height="355">
</div>
<p align="center">
<span class="style9"><strong><font color="#993366">–ис. 4.</font></strong></span> ѕродавец блокирует все €блоки, которые нрав€тс€ »ванову
</p>
<br>
<p>
¬ это врем€ подходит ѕетров и не может купить ни одного €блока, потому что они все заблокированы »вановым (рис. 5).
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/pic_05.jpg" alt="–ис. 5. ѕетров не может купить ни одного €блока" title="–ис. 5. ѕетров не может купить ни одного €блока" width="575" height="355">
</p>
<p align="center">
<span class="style9"><strong><font color="#993366">–ис. 5.</font></strong></span> ѕетров не может купить ни одного €блока
</p>
<br>
<p>
ѕетров ждет некоторое врем€, обижаетс€ и уходит (рис. 6). Ёто событие соответствует ошибке "ѕревышение времени ожидани€ блокировки".
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/pic_04.jpg" alt="–ис. 6. ѕетров не дождалс€ и ушел" title="–ис. 6. ѕетров не дождалс€ и ушел" width="575" height="355">
</p>
<p align="center">
<span class="style9"><font color="#993366"><strong>–ис. 6.</strong></font> </span>ѕетров не дождалс€ и ушел
</p>
<br>
<p>
ј »ванов, в результате, выбирает одно единственное €блоко (самое лучшее) и покупает только его (рис. 7).
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/pic_06.jpg" alt="–ис. 7. »ванов покупает только одно €блоко" title="–ис. 7. »ванов покупает только одно €блоко" width="575" height="355">
</p>
<p align="center">
<span class="style9"><font color="#993366"><strong>–ис. 7.</strong></font></span> »ванов покупает только одно €блоко
</p>
<br>
<p>
“аким образом все остальные €блоки были заблокированы зр€. ≈сли бы этих блокировок не было, то ѕетров, возможно, тоже купил бы €блоко.
</p>
<br>
<p>
¬ данном случае (в отличие от первого примера) ѕетров как раз столкнулс€ с Ђплохимиї (избыточными) блокировками.
</p>
<br>
<p>
ѕодвод€ итог сказанному важно отметить, что Ђхорошиеї блокировки об€зательно должны присутствовать в прикладном решении. »менно благодар€ им обеспечиваетс€ предсказуемость действий пользователей, целостность и непротиворечивость данных.
</p>
<br>
<p>
— Ђплохимиї блокировками нужно боротьс€ и в идеале их не должно существовать в прикладном решении. ѕричины возникновени€ плохих блокировок могут быть самыми разнообразными: прикладна€ логика, особенности работы той или иной —”Ѕƒ и т.д. ¬ данной статье мы познакомимс€ лишь с механизмами системы 1—:ѕредпри€тие 8.1, которые используют блокировки и дадим рекомендации по правильному их использованию. “ема же анализа существующих блокировок и их оптимизации достаточно сложна€ и объемна€, и выходит за рамки данной статьи.
</p>
<h2 align="center">ќбъектные и транзакционные блокировки</h2>
<p>
¬ системе 1—:ѕредпри€тие 8 существуют два механизма, при работе которых используетс€ термин блокировка. «ачастую это приводит к путанице и позвол€ет думать, что речь идет об одних и тех же блокировках или об одном и том же механизме. Ќа самом деле это не так.  аждый из этих механизмов предназначен дл€ обеспечени€ конкуретной работы пользователей, однако в своей, определенной области, и при этом блокировки, используемые одним и другим механизмами, имеют совершенно различный смысл (рис. 8).
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/ch03_008.png" alt="–ис. 3.8. ќбъектные и транзакционные блокировки" title="–ис. 3.8. ќбъектные и транзакционные блокировки" width="690" height="571">
</p>
<p align="center">
<span class="style9"><strong><font color="#993366">–ис. 8.</font></strong></span> ќбъектные и транзакционные блокировки
</p>
<br>
<p>
Ћогическа€ модель данных 1—:ѕредпри€ти€ 8 предполагает, что на самом Ђверхнемї уровне абстрации пользователь имеет дело с объектами системы, как совокупностью неделимых данных. “акими объектами, например, €вл€ютс€ элементы справочников, документы и др. Ёлемент справочника может содержать большое количество реквизитов, несколько табличных частей, но все эти данные необходимо измен€ть одновременно и согласованно. <span class="style4"><em><font color="#ff6600">ћеханизм объектных блокировок</font></em></span> как раз и позвол€ет осуществл€ть конкурентный доступ пользователей к данным 1—:ѕредпри€ти€ в терминах объектов информационной базы.  ак правило в большинстве случаев это св€зано с интерактивной работой пользователей в формах: редактирование существующих объектов, удаление, создание новых и др.
</p>
<br>
<p>
¬ то же врем€ все данные информационной базы хран€тс€ в некоторой —”Ѕƒ. ј люба€ —”Ѕƒ должна обеспечивать целостность и непротиворечивость хранимых данных. ƒл€ согласованного изменени€ данных в —”Ѕƒ используетс€ механизм транзакций, а дл€ обеспечени€ конкурентного доступа к данным - <span class="style4"><font color="#ff6600"><em>механизм транзакционных блокировок</em></font></span>.
</p>
<br>
<p>
“аким образом и тот, и другой механизмы обеспечивают конкурентную работу пользователей, однако области их действи€ и смысл устанавливаемых блокировок €вл€ютс€ совершенно разными.
</p>
<br>
<p>
ƒалее рассмотрим работу этих двух механизмов более подробно.
</p>
<br>
<h2 align="center">ћеханизм объектных блокировок</h2>
<h3 align="center">ќбъектна€ пессимистическа€ блокировка</h3>
<p align="left">
ѕессимистическа€ блокировка объектов базы данных предназначена дл€ того, чтобы запретить изменение данных определенного объекта другими сеансами или данным сеансом до тех пор, пока блокировка не будет сн€та этим объектом встроенного €зыка.
</p>
<br>
<p>
¬ основном механизм пессимистической блокировки используетс€ системой 1—:ѕредпри€тие 8.1 дл€ блокировки объектов, редактируемых в форме. ¬ тот момент, когда пользователь начинает модификацию объекта в форме, расширение формы устанавливает пессимистическую блокировку. ≈сли после этого другой пользователь, например, попытаетс€ выполнить редактирование того же объекта, ему будет выдано сообщение о том, что не удалось заблокировать объект.  огда пользователь, редактировавший объект, закроет форму объекта, расширение формы снимет пессимистическую блокировку.
</p>
<br>
<p>
–ассмотрим пример. ¬ойдем в прилагаемую к работе информационную базу под пользователем <span class="style6"><font color="#0000ff">»ванов</font></span>, откроем форму элемента <span class="style6"><font color="#0000ff">1—:ѕредпри€тие 8.0. ”правление торговлей</font></span> справочника <span class="style6"><font color="#0000ff">Ќоменклатура</font></span> (код 12) и изменим цену продажи с <span class="style6"><font color="#0000ff">420,00</font></span> на <span class="style6"><font color="#0000ff">450,00</font></span>. <span class="style9"><strong><font color="#993366">Ќе сохран€€ сделанные изменени€</font></strong></span>, войдем в информационную базу еще раз, но теперь под именем пользовател€ <span class="style6"><font color="#0000ff">ѕетров</font></span>. ќткроем форму того же элемента справочника и попробуем изменить значение какого-либо реквизита. Ћюба€ попытка изменени€ приведет к по€влению специального окна с сообщением об ошибке (рис. 9):
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/ch03_009.png" alt="–ис. 3.9. ѕример работы пессимистической блокировки" title="–ис. 3.9. ѕример работы пессимистической блокировки" width="740" height="263">
</p>
<p align="center">
<span class="style9"><strong><font color="#993366">–ис. 9.</font></strong></span> ѕример работы пессимистической блокировки
</p>
<br>
<p>
“аким образом пессимистическа€ блокировка гарантирует, что пользователь, начав измен€ть данные объекта, сможет записать эти изменени€ в информационную базу.
</p>
<br>
<p>
¬ то же врем€, разработчик имеет возможность задействовать рассматриваемый механизм, использу€ средства встроенного €зыка. ƒл€ того, чтобы установить пессимистическую блокировку объекта, можно использовать метод объекта <span class="style10"><font color="#0000ff">«аблокировать()</font></span>.
</p>
<br>
<p class="style11">
<strong>¬Ќ»ћјЌ»≈</strong>
</p>
<blockquote>
	<p>
	¬ажным отличием версии 8.1 платформы 1—:ѕредпри€тие €вл€етс€ то, что сам по себе факт установки блокировки не преп€тствует изменению или удалению объекта в базе данных. ѕоэтому дл€ того, чтобы обеспечить невозможность изменени€ заблокированного объекта, операции изменени€ объекта в другом сеансе должна также предшествовать попытка блокировки того же самого объекта. Ѕлокировка заблокированного объекта базы данных вызывает исключение, которое может быть обработано конструкцией <span class="style10"><font color="#0000ff">ѕопытка ... »сключение ...  онецѕопытки</font></span>.
	</p>
</blockquote>
<p>
<br>
ƒл€ сн€ти€ пессимистической блокировки разработчик может использовать метод объекта <font color="#0000ff">–азблокировать()</font>, причем использовать его дл€ того же самого экземпл€ра объекта, дл€ которого ранее была установлена блокировка.
</p>
<br>
<p>
–ассматрива€ возможность взаимного вли€ни€ механизмов объектных и транзакционных блокировок, напомним, что объектные блокировки не вли€ют на операции над данными и на процесс течени€ транзакций (обратите внимание, на рис 8 они расположены на разных уровн€х работы с данными). ≈сли блокировка объекта вызвала исключение, то оно, как было указано выше, может быть обработано разработчиком конфигурации и не приведет к об€зательному откату транзакции. — другой стороны, блокировки объектов, установленные в течение транзакции, сохран€ютс€ при фиксации транзакции и снимаютс€ при откате транзакции.
</p>
<br>
<h3>ќбъектна€ оптимистическа€ блокировка</h3>
<p>
ќптимистическа€ блокировка запрещает запись объекта в базу данных, если после считывани€ объекта он был изменен в базе данных другими сеансами или другими программными объектами этого же сеанса.
</p>
<br>
<p>
‘актически, оптимистическа€ блокировка представл€ет собой проверку, котора€ выполн€етс€ перед записью объекта в базу данных. Ёта проверка построена на анализе номера версии объекта, хран€щейс€ в базе данных и номера версии, помещенной в пам€ть компьютера в момент считывани€ данных из информационной базы. ≈сли при записи объекта номера его версий отличаютс€, то будет выдано предупреждение о том, что верси€ объекта изменилась или он был удален, то есть сработает оптимистическа€ блокировка.
</p>
<br>
<p>
–ассмотрим пример. ќткроем два сеанса работы с прилагаемой к работе информационной базой: один под пользователем <span class="style6"><font color="#0000ff">»ванов</font></span>, а другой - под пользователем <span class="style6"><font color="#0000ff">ѕетров</font></span>. ¬ обоих сеансах откроем откроем форму элемента <span class="style6"><font color="#0000ff">”правление торговлей</font></span> справочника <span class="style6"><font color="#0000ff">Ќоменклатура</font></span> (код 12). “еперь в сеансе, открытом от имени пользовател€ <span class="style6"><font color="#0000ff">»ванов</font></span>, изменим цену продажи с <span class="style6"><font color="#0000ff">420,00</font></span> на <span class="style6"><font color="#0000ff">450,00</font></span> и <span class="style9"><strong><font color="#993366">запишем сделанные изменени€</font></strong></span>. ѕосле этого, в сеансе, открытом от имени пользовател€ <span class="style6"><font color="#3366ff">ѕетров</font></span> попробуем изменить значение какого-либо реквизита. Ћюба€ попытка изменени€ приведет к по€влению другого окна с сообщением об ошибке (рис. 10):
</p>
<br>
<p style="text-align: center">
<img src="./tran-isolation/ch03_010.PNG" alt="–ис. 3.10. ѕример работы оптимистической блокировки" title="–ис. 3.10. ѕример работы оптимистической блокировки" width="804" height="265">
</p>
<p align="center">
<span class="style9"><strong><font color="#993366">–ис. 10.</font></strong></span> ѕример работы оптимистической блокировки
</p>
<br>
<p>
“аким образом оптимистическа€ блокировка гарантирует, что пользователь измен€ет актуальные данные объекта, которые хран€тс€ в информационной базе, а не какой-то их предыдущий вариант.
</p>
<br>
<h2 align="center">ћеханизм транзакционных блокировок</h2>
<h3 align="center">ќбщие сведени€ о транзакци€х и блокировках —”Ѕƒ</h3>
<p>
ѕрежде чем перейти к рассмотрению механизмов платформы 1—:ѕредпри€тие, познакомимс€ в общих чертах с пон€ти€ми, которые будут использованы далее.
</p>
<br>
ѕон€тие транзакционной блокировки неразрывно св€зано с пон€тием транзакции.<br>
<br>
<p>
<em><font color="#ff6600">“ранзакци€</font></em> - это неделима€, с точки зрени€ воздействи€ на базу данных, последовательность операций манипулировани€ данными, выполн€юща€с€ по принципу Ђвсе или ничегої, и перевод€ща€ базу данных из одного целостного состо€ни€ в другое целостное состо€ние. ≈сли по каким-либо причинам одно из действий транзакции невыполнимо или произошло какое-либо нарушение работы системы, база данных возвращаетс€ в то состо€ние, которое было до начала транзакции (происходит откат транзакции).
</p>
<br>
<h4 align="center">¬озможные проблемы при многопользовательском доступе к одним и тем же данным</h4><br>
<p>
–абота в многопользовательской среде требует соблюдени€ определенного компромисса между требовани€ми предсказуемости, целостности и непротиворечивости данных информационной базы и требовани€ми параллельности работы.
</p>
<br>
<p>
 ак известно, при одновременном чтении и изменении одних и тех же данных конкурирующими транзакци€ми могут возникнуть следующие проблемы одновременного доступа:
</p>
<ul>
	<li><span class="style4"><em><font color="#ff6600">ѕроблема потер€нного изменени€ (англ. The Lost Update Problem)</font></em> </span>- если две транзакции измен€ют одни и те же данные, вз€в в качестве первоисточника начальное значение этих данных, то в системе останутс€ изменени€ внесенные той транзакцией, котора€ записала свои изменени€ последней, поскольку эти изменени€ замен€т собой все изменени€, внесенные до этого. </li>
</ul>
<blockquote>
	<p>
	<span class="style9"><strong><font color="#993366">ѕример.</font></strong></span> –ассмотрим следующий пример. ƒопустим в справочнике <span class="style6"><font color="#0000ff">Ќоменклатура</font></span>, “ранзакци€ є1 обратилась к элементу <span class="style6"><font color="#0000ff">1—:ѕредпри€тие 8.0. ”правление торговлей</font></span> и решила изменить значение реквизита <span class="style6"><font color="#0000ff">÷енаѕродажи</font></span> с <span class="style6"><font color="#0000ff">420</font></span> на <span class="style6"><font color="#0000ff">450</font></span>. ќдновременно “ранзакци€ є2 решила у этого же товара изменить значение реквизита <span class="style6"><font color="#0000ff">≈диница»змерени€</font></span> со <span class="style6"><font color="#0000ff">Ўтука</font></span> на <span class="style6"><font color="#0000ff"> оробка</font></span>. –аспределение по времени описанных действий показано на рис. 11. “аким образом, в элементе справочника остались только те изменени€, которые сделала “ранзакци€ є2.
	</p>
	<p>
	<span class="style9"><strong><font color="#993366">¬ывод.</font></strong></span> Ќельз€ одновременно измен€ть одни и те же данные;
	</p>
</blockquote>
<p>
<img src="./tran-isolation/ch03_011.png" alt="–ис. 3.11. »ллюстраци€ проблемы последнего изменени€" title="–ис. 3.11. »ллюстраци€ проблемы последнего изменени€" width="1133" height="506">
</p>
<font color="#993366"><strong>–ис. 11.</strong></font> »ллюстраци€ проблемы потер€нного изменени€&nbsp;
<ul>
	<li><em><font color="#ff6600">ѕроблема Ђгр€зногої чтени€ (англ. The Uncommitted Dependency Problem)</font></em> - если одна транзакци€ начнет считывать некоторые данные не дождавшись окончани€ внесени€ изменений, вносимых в эти данные другой транзакцией, то достаточно веро€тен случай, когда прочитанные данные будут содержать неверную информацию.</li>
</ul>
<blockquote>
	<strong><font color="#993366">ѕример.</font></strong> ¬ернемс€ к примеру, рассмотренному выше. ƒопустим в справочнике <font color="#0000ff">Ќоменклатура</font>, “ранзакци€ є1 обратилась к элементу <font color="#3366ff">1—:ѕредпри€тие 8.0. ”правление торговлей</font> и изменила значение реквизита <font color="#3366ff">÷енаѕродажи</font> с <font color="#3366ff">420</font> на <font color="#3366ff">450</font>. Ќе дождавшись фиксации изменений, “ранзакци€ є2 использовала значение реквизита дл€ определени€ суммы продажи. ќднако, перва€ транзакци€ решила не сохран€ть внесенные изменени€ (откат транзакции) и восстановила старые данные. √рафическое представление действий транзакций показано на рис. 12. “аким образом, “ранзакци€ є2 в своих расчетах использовала данные, не существующие в системе.<strong><font color="#993366">¬ывод.</font></strong> Ќельз€ читать уже измененные, но еще не записанные данные.
</blockquote>
<p align="center">
<img src="./tran-isolation/ch03_012.png" alt="–ис. 3.12. »ллюстраци€ проблемы Ђгр€зногої чтени€" title="–ис. 3.12. »ллюстраци€ проблемы Ђгр€зногої чтени€" width="1126" height="527"><strong><font color="#993366">–ис. 12.</font></strong> »ллюстраци€ проблемы Ђгр€зногої чтени€
</p>
<ul>
	<li><em><font color="#ff6600">ѕроблема неповтор€емого чтени€ (англ. The Inconsistent Analysis Problem) </font></em>- если одна транзакци€ несколько раз считывает одни и те же данные, а втора€ - вносит изменени€ в эти данные между циклами чтени€ данных первой транзакции, то при повторном считывании перва€ транзакци€ может получить другой набор данных.</li>
</ul>
<blockquote>
	<p>
	<strong><font color="#993366">ѕример.</font></strong> ƒопустим, в нашем примере, “ранзакци€ є1 два раза подр€д обращаетс€ к элементу справочника <font color="#3366ff">1—:ѕредпри€тие 8.0. ”правление торговлей</font> и каждый раз считывает значение реквизита <font color="#3366ff">÷енаѕродажи</font>. ≈сли в промежуток между первым и вторым чтением вклинитс€ “ранзакци€ є2 и изменит значение этого реквизита, то в результате получитс€, что перва€ транзакци€ работает с данными, которые с ее точки зрени€ самопроизвольно измен€ютс€. √рафическое представление данной проблемы показано на рис. 13.
	</p>
	<p>
	<font color="#993366"><strong>¬ыводы. </strong></font>Ќельз€ повторно читать измененные и записанные данные, если эти же самые данные уже были прочитаны до внесени€ в них изменений;
	</p>
</blockquote>
<p>
<img src="./tran-isolation/ch03_013.png" alt="–ис. 3.13. »ллюстраци€ проблемы неповтор€емого чтени€" title="–ис. 3.13. »ллюстраци€ проблемы неповтор€емого чтени€" width="1120" height="474">
</p>
<p align="center">
<strong><font color="#993366">–ис. 13.</font></strong> »ллюстраци€ проблемы неповтор€емого чтени€
</p>
<ul>
	<li><em><font color="#ff6600">ѕроблема чтени€ фантомов (англ. The Phantom Read Problem)</font></em> - если перва€ транзакци€ считывает данные и потом на их основе осуществл€ет определенные действи€, а втора€ транзакци€ в этот момент добавл€ет в эти данные новую информацию, то как и в предыдущем случае это может привести к некорректному результату. </li>
</ul>
<blockquote>
	<p>
	<strong><font color="#993366">ѕример.</font></strong> ƒопустим, компани€ занимаетс€ продажей товаров и состоит из нескольких отделов. ¬ случае, когда объем продаж сотрудников одного отдела превышает 1000 рублей, то каждый сотрудник отдела получает премию 20 % от суммы своих продаж. ¬ противном случае, размер премии составл€ет 10 %. ќчевидно, что процесс начислени€ премии сотрудникам каждого отдела будет состо€ть из нескольких операций:
	</p>
	<ul>
		<li>получени€ общей суммы продаж по отделу в целом путем суммировани€ отдельных продаж по каждому из сотрудников;</li>
		<li>определени€ на основании полученных данных процента премии;</li>
		<li>расчета суммы премии дл€ каждого из сотрудников отдела.</li>
	</ul>
	<p>
	ѕредположим, что данные о продажах вводит “ранзакци€ є2, а размер премии рассчитывает “ранзакци€ є1. “огда при одновременной работе транзакций может возникнуть ситуаци€, показанна€ на рис. 14. “аким образом, “ранзакци€ є1 в двух одинаковых выборках строк получил разные результаты.
	</p>
	<p>
	<strong><font color="#993366">¬ыводы. </font></strong>Ќельз€ вводить новые данные (удалить имеющиес€), если они могут попасть в уже один раз прочитанные данные при повторном чтении.
	</p>
</blockquote>
<p>
<img src="./tran-isolation/ch03_014.png" alt="–ис. 3.14. »ллюстраци€ проблемы фантомов" title="–ис. 3.14. »ллюстраци€ проблемы фантомов" width="930" height="428">
</p>
<p align="center">
<strong><font color="#993366">–ис. 14.</font></strong> »ллюстраци€ проблемы фантомов
</p>
<p>
&nbsp;
</p>
<p>
—трого говор€, список вышеперечисленных проблем не €вл€етс€ окончательным.
</p>
<h3 align="center">”ровни изол€ции транзакций</h3>
<p>
»так, ради увеличени€ производительности системы мы должны допустить параллельное выполнение транзакций. ѕри этом мы так же должны обеспечить необходимую нам степень целостности данных (то есть, ограничить параллельность транзакций при работе с одними ресурсами). —трогость этих ограничений может быть различной, в зависимости от решаемой задачи. ѕоэтому нам необходим механизм гибкой настройки этих ограничений. ¬ современных —”Ѕƒ така€ возможность реализуетс€ путем применени€ <font color="#ff0000"><em>уровней изол€ции транзакций</em></font>. Ќапример, MS SQL Server 2000 позвол€ет использовать следующие уровни изол€ции транзакции:
</p>
<ul>
	<li><strong><font color="#993366">READ UNCOMMITED</font></strong> - незавершенное чтение. Ќизший уровень изол€ции, обеспечивает максимальную параллельность выполнени€ транзакций. ƒанный уровень защищает измен€емые мной данные от изменений, которые могут внести конкурирующие транзакции. ≈сли другой транзакции необходимо <font color="#ff6600"><em>изменить</em></font> те же самые данные, то она должна ожидать завершени€ <font color="#ff6600"><em>изменени€</em></font> данных моей транзакцией. ќднако чтение данных разрешено. “аким образом этот уровень изол€ции допускает чтение незавершенных изменений данных.</li>
	<li><strong><font color="#993366">READ COMMITED</font></strong> -&nbsp; обеспечивает запрет Ђгр€зногої чтени€. ≈сли мо€ транзакци€ начала <font color="#ff6600"><em>измен€ть</em></font> данные, то конкурирующа€ транзакци€ не может не только измененить, но даже <font color="#ff6600"><em>прочитать </em><font color="#000000">их до</font></font> завершени€ моих изменений. ѕосле того, как мои изменени€ закончены, конкурирующие транзакции могут читать данные, не дожида€сь окончани€ моей транзакции в целом. “аким образом существует проблема неповтор€емого чтени€.</li>
	<li><font color="#993366"><strong>REPEATABLE READ</strong></font> - обеспечивает повтор€емость чтени€ данных. ≈сли мо€ транзакци€ начинает <font color="#ff6600"><em>читать</em></font> данные, то друга€ транзакци€ не может их <em><font color="#ff6600">изменить</font></em> до окончани€ моей транзакции.</li>
	<li><strong><font color="#993366">SERIALIZABLE</font></strong> - последовательное выполнение. Ётот уровень изол€ции €вл€етс€ максимальным и обеспечивает полную изол€цию транзакций друг от друга. –ешаютс€ все рассмотренные проблемы, включа€ проблему Ђфантомовї.</li>
</ul>
<p>
¬ зависимости от используемого уровн€ изол€ции, —”Ѕƒ накладывает различные типы блокировок на различные объекты базы данных на различное врем€.
</p>
<h2 align="center">–ежим автоматических блокировок</h2>
<p>
–ежим автоматических блокировок в 1—:ѕредпри€тии 8.1 полностью аналогичен механизму транзакционных блокировок, использовавшемус€ в версии 8.0. ¬ этом режиме 1—:ѕредпри€тие целиком Ђполагаетс€ї на возможности, предоставл€емые —”Ѕƒ (рис. 15).
</p>
<div style="text-align: center">
<img src="./tran-isolation/ch03_015.png" alt="–ис. 3.15. јтоматические блокировки в транзакции 1—:ѕредпри€ти€ 8" title="–ис. 3.15. јтоматические блокировки в транзакции 1—:ѕредпри€ти€ 8" width="369" height="267">
</div>
<p align="center">
<font color="#993366"><strong>–ис. 15.</strong></font> јвтоматические блокировки в транзакции 1—:ѕредпри€ти€ 8
</p>
<p>
&nbsp;
</p>
<p>
“акой подход позвол€ет разработчику не задумыватьс€ о достаточно сложных вопросах блокировани€ нужных данных в транзакции. ќднако —”Ѕƒ не имеет информации о логической структуре данных 1—:ѕредпри€ти€, и платформе приходитс€ использовать достаточно высокие уровни изол€ции транзакций —”Ѕƒ дл€ того, чтобы обеспечить целостность и непротиворечивость данных (табл. 3): Repeatable Read и Serializable дл€ MS SQL Server, Serializable дл€ IBM DB2 и блокировка таблиц целиком дл€ PostgreSQL.
</p>
<p>
&nbsp;
</p>
<p align="center">
<strong><font color="#993366">“аблица 3.</font></strong> Ѕлокировки —”Ѕƒ, используемые в режиме автоматических блокировок в транзакции
</p>
<table border="1" cellspacing="2" cellpadding="5" align="center">
	<tbody>
		<tr>
			<td>&nbsp;</td>
			<td colspan="4">
			<p align="center">
			<strong>—”Ѕƒ</strong>
			</p>
			</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td>
			<p align="center">
			&nbsp;<strong>‘айлова€ база данных</strong>
			</p>
			</td>
			<td>
			<p align="center">
			<strong>&nbsp;MS SQL Server</strong>
			</p>
			</td>
			<td>
			<p align="center">
			<strong>&nbsp;IBM DB2</strong>
			</p>
			</td>
			<td>
			<p align="center">
			<strong>&nbsp;PostgreSQL</strong>
			</p>
			</td>
		</tr>
		<tr>
			<td>&nbsp;<strong>¬ид блокировок</strong></td>
			<td>
			<p align="center">
			&nbsp;“аблиц
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;«аписей
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;«аписей
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;“аблиц
			</p>
			</td>
		</tr>
		<tr>
			<td>&nbsp;<strong>”ровень изол€ции транзакций</strong></td>
			<td>
			<p align="center">
			&nbsp;Serializable
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;Repeatable Read или Serializable
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;Serializable
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;Read Committed
			</p>
			</td>
		</tr>
	</tbody>
</table>
<p>
<br>
«ачастую такой подход приводит к возникновению Ђплохихї (избыточных) блокировок и не позвол€ет достичь желаемой параллельности работы пользователей. ¬ клиент-серверном варианте блокировка данных происходит на уровне записей, однако может быть заблокирована и вс€ таблица целиком (например, в результате выбора —”Ѕƒ <a href="http://kb.1c.ru/articleView.jsp?id=16">неоптимального плана выполнени€ запроса</a> ). “ип блокировок, устанавливаемых в том или ином случае, зависит от вида операции, используемого 1—:ѕредпри€тием уровн€ изол€ции транзакций и определ€етс€ внутренними механизмами самой —”Ѕƒ (например, MS SQL Server).
</p>
<h2 align="center">–ежим управл€емых блокировок</h2>
<p>
¬ 1—:ѕредпри€тии версии 8.1 реализован дополнительный режим работы, позвол€ющий использовать собственный менеджер транзакционных блокировок 1—:ѕредпри€ти€, независимый от используемой —”Ѕƒ (рис. 16).
</p>
<p>
&nbsp;
</p>
<div style="text-align: center">
<img src="./tran-isolation/ch03_016.png" alt="–ис. 3.16. ”правл€емые блокировки в транзакции 1—:ѕредпри€ти€ 8.1" title="–ис. 3.16. ”правл€емые блокировки в транзакции 1—:ѕредпри€ти€ 8.1" width="372" height="327">
</div>
<p align="center">
<strong><font color="#993366">–ис. 16.</font></strong> ”правл€емые блокировки в транзакции 1—:ѕредпри€ти€ 8.1
</p>
<p align="center">
&nbsp;
</p>
<p align="left">
ѕри работе в этом режиме система использует гораздо более низкий уровень изол€ции транзакций дл€ MS SQL Server и IBM DB2, и блокировку на уровне записей дл€ PostgreSQL (см. таблицу 3). Ёто позвол€ет достичь более высокой параллельности работы пользователей.
</p>
<p align="left">
&nbsp;
</p>
<p align="center">
<strong><font color="#993366">“аблица 3.</font></strong> Ѕлокировки —”Ѕƒ, используемые в режиме управл€емых блокировок в транзакции
</p>
<table border="1" cellspacing="2" cellpadding="5" align="center">
	<tbody>
		<tr>
			<td>&nbsp;</td>
			<td colspan="4">
			<p align="center">
			<strong>—”Ѕƒ</strong>
			</p>
			</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
			<td>
			<p align="center">
			&nbsp;<strong>‘айлова€ база данных</strong>
			</p>
			</td>
			<td>
			<p align="center">
			<strong>&nbsp;MS SQL Server</strong>
			</p>
			</td>
			<td>
			<p align="center">
			<strong>&nbsp;IBM DB2</strong>
			</p>
			</td>
			<td>
			<p align="center">
			<strong>&nbsp;PostgreSQL</strong>
			</p>
			</td>
		</tr>
		<tr>
			<td>&nbsp;<strong>¬ид блокировок</strong></td>
			<td>
			<p align="center">
			&nbsp;“аблиц
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;«аписей
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;«аписей
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;«аписей
			</p>
			</td>
		</tr>
		<tr>
			<td>&nbsp;<strong>”ровень изол€ции транзакций</strong></td>
			<td>
			<p align="center">
			&nbsp;Serializable
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;Read Committed
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;Read Committed
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;Read Committed
			</p>
			</td>
		</tr>
	</tbody>
</table>
<p align="left">
&nbsp;
</p>
<p align="left">
ќднако этот уровень изол€ции транзакций —”Ѕƒ уже не может сам по себе обеспечить целостность и непротиворечивость данных во всех случа€х. ѕоэтому 1—:ѕредпри€тие 8.1 при модификации данных методами встроенного €зыка (например, метод «аписать() у объектных данных) устанавливает собственные управл€емые блокировки в транзакции, которые обрабатываютс€ собственным менеджером транзакционных блокировок. Ёти блокировки также могут быть установлены и разработчиком самосто€тельно в тех местах кода, где требуетс€ обеспечить неизменность считываемых в транзакции данных (раздел€ема€ блокировка) или запретить чтение данных другими транзакци€ми (исключительна€ блокировка).
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
”правл€емые блокировки 1—:ѕредпри€ти€ учитывают логическую структуру прикладного решени€ поэтому позвол€ют максимально точно блокировать необходимые области данных (в отличие от использовавшихс€ ранее блокировок —”Ѕƒ, которым не известна логическа€ структура системы). “аким образом менеджер управл€емых блокировок позовл€ет максимально избежать возникновени€ Ђплохихї (избыточных) блокировок, блокирую€ только действительно необходимые области данных.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬ результате любой запрос к данным прежде всего обрабатываетс€ собственным менеджером транзакционных блокировок 1—:ѕредпри€ти€ 8.1 (см. рис. 16). ≈сли на уровне 1—:ѕредпри€ти€ 8.1 конфликт управл€емых блокировок не обнаруживаетс€, то запрос передаетс€ далее, на исполнение —”Ѕƒ. —”Ѕƒ также использует собственный механизм блокировок дл€ определени€ конфликтующих транзакций, но уже с более низким уровнем изол€ции транзакций, чем в режиме автоматических блокировок.
</p>
<h2 align="center">”становка режима управлени€ блокировками дл€ объектов конфигурации</h2>
<p align="left">
¬ структуре объектов конфигурации существует несколько возможностей дл€ задани€ режима управлени€ блокировками.
</p>
<p align="left">
<br>
ѕрежде всего существует свойство –ежим управлени€ блокировкой данных самой конфигурации (рис. 17).
</p>
<p align="left">
&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_017_example.png" alt="–ис. 3.17. —писок значений свойства Ђ–ежим управлени€ блокировкой данныхї в палитре свойств  онфигурации" title="–ис. 3.17. —писок значений свойства Ђ–ежим управлени€ блокировкой данныхї в палитре свойств  онфигурации" width="498" height="375">
</p>
<p align="center">
<strong><font color="#993366">–ис. 17.</font></strong> —писок значений свойства Ђ–ежим управлени€ блокировкой данныхї в палитре свойств  онфигурации
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
ѕри выборе значений <font color="#3366ff">јвтоматический</font> или <font color="#3366ff">”правл€емый</font> режим блокировок при чтении или записи данных любого объекта конфигурации будет определ€тьс€ именно этим выбранным значением.
</p>
<p align="left">
<br>
Ќапример, если установлен режим <font color="#3366ff">јвтоматический</font>, то при записи, скажем, любого элемента справочника, будут использоватьс€ автоматические блокировки, устанавливаемые —”Ѕƒ. —обственнный менеджер блокировок задействован не будет. ѕоведение системы будет полностью аналогичным поведению версии 8.0.
</p>
<p align="left">
<br>
≈сли же установлен режим <font color="#3366ff">”правл€емый</font>, то, независимо от того, какие режимы управлени€ блокировками установлены дл€ конкретных объектов конфигурации (об этом смотри далее), при записи, скажем, документа система всегда будет самосто€тельно устанавливать необходимые управл€емые блокировки, которые будут обрабатыватьс€ собственным менеджером транзакционных блокировок. Ётот режим предназначен дл€ работы всей конфигурации только с управл€емыми блокировками в транзакции.
</p>
<p align="left">
<br>
≈сли же дл€ свойства конфигурации выбран режим <font color="#3366ff">јвтоматический и управл€емый</font>, то дл€ конкретного объекта конфигурации режим блокировки будет определ€тьс€ значением свойства <font color="#3366ff">–ежим управлени€ блокировкой данных</font> самого объекта конфигурации (рис. 18).
</p>
<p align="left">
&nbsp;
</p>
<p align="center">
&nbsp;<img src="./tran-isolation/ch03_018_example.png" alt="–ис. 3.18. —писок значений свойства Ђ–ежим управлени€ блокировкой данныхї в палитре свойств объекта конфигурации" title="–ис. 3.18. —писок значений свойства Ђ–ежим управлени€ блокировкой данныхї в палитре свойств объекта конфигурации" width="498" height="375">
</p>
<p align="center">
<strong><font color="#993366">–ис. 18.</font></strong> —писок значений свойства Ђ–ежим управлени€ блокировкой данныхї в палитре свойств объекта конфигурации
</p>
<p align="center">
&nbsp;
</p>
<p align="left">
Ётот режим предназначен дл€ постепенного или частичного перевода конфигурации в режим управл€емых блокировок. ќн позвол€ет отдельным объектам метаданных работать с управл€емыми блокировками (например, наиболее Ђпроблемнымї документам и регистрам), в то врем€ как остальные объекты работают в режиме автоматических блокировок.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬ажной особенностью работы в режиме <font color="#3366ff">јвтоматический и управл€емый</font> €вл€етс€ то, что не во всех ситуаци€х работа с данными объекта будет выполн€тьс€ именно в том режиме, который дл€ него указан. –ассмотрим эту особенность подробно.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬нутри одной транзакции, котора€ начата и не завершена 1—:ѕредпри€тием, может быть начата еще одна (или несколько) транзакций. “ака€ логика работы обеспечиваетс€ платформой автоматически, а также поддерживаетс€ средствами встроенного €зыка.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬ 1—:ѕредпри€тии 8.1 при начале каждой транзакции €вно (если она начата из встроенного €зыка) или не€вно (если она начата в результате действий самой системы) указываетс€ режим управлени€ блокировками в данной транзакции (автоматический или управл€емый). “аким образом может оказатьс€, что перва€ (объемлюща€) транзакци€ открыта в одном режиме, а втора€ - в другом режиме управлени€ блокировками. ¬сего может быть четыре различных сочетани€, которые представлены в таблице 3.
</p>
<p align="center">
<br>
<strong><font color="#993366">“аблица 3.</font></strong> —очетани€ режимов управлени€ блокировками в транзакции
</p>
<table border="1" cellspacing="2" cellpadding="5" align="center">
	<tbody>
		<tr>
			<td>
			<p align="center">
			<strong>–ежим существующей транзакции</strong>&nbsp;
			</p>
			</td>
			<td>
			<p align="center">
			<strong>–ежим начинаемой транзакции</strong>&nbsp;
			</p>
			</td>
			<td>
			<p align="center">
			<strong>–езультат</strong>&nbsp;
			</p>
			</td>
		</tr>
		<tr>
			<td>
			<p align="center">
			&nbsp;јвтоматический
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;јвтоматический
			</p>
			</td>
			<td>
			<p align="left">
			&nbsp;Ќачинаема€ транзакци€ будет выполнена в <strong>автоматическом</strong> режиме
			</p>
			</td>
		</tr>
		<tr>
			<td>
			<p align="center">
			&nbsp;”правл€емый
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;”правл€емый
			</p>
			</td>
			<td>
			<p align="left">
			&nbsp;Ќачинаема€ транзакци€ будет выполнена в <strong>управл€емом</strong> режиме
			</p>
			</td>
		</tr>
		<tr>
			<td>
			<p align="center">
			&nbsp;јвтоматический
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;”правл€емый
			</p>
			</td>
			<td>
			<p align="left">
			&nbsp;Ќачинаема€ транзакци€ будет выполнена в <strong>автоматическом</strong> режиме
			</p>
			</td>
		</tr>
		<tr>
			<td>
			<p align="center">
			&nbsp;”правл€емый
			</p>
			</td>
			<td>
			<p align="center">
			&nbsp;јвтоматический
			</p>
			</td>
			<td>
			<p align="left">
			&nbsp;Ѕудет вызвана исключительна€ ситуаци€
			</p>
			</td>
		</tr>
	</tbody>
</table>
<p align="left">
&nbsp;
</p>
<p align="left">
”казанна€ ранее особенность про€вл€етс€ в последних двух строках таблицы. ≈сли существующа€ транзакци€ начата в автоматическом режиме, то начинаема€ транзакци€ таже будет выполнена в автоматическом режиме, даже в том случае, если €вно (во втроенном €зыке) или не€вно (в свойствах объекта конфигурации) дл€ нее установлен управл€емый режим блокировок.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
≈сли же существующа€ транзакци€ начата в управл€емом режиме, то начинаема€ транзакци€ может быть выполнена только в том случае, если дл€ нее также указан управл€емый режим. ≈сли дл€ нее указан автоматический режим - будет вызвана исключительна€ ситуаци€.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
–азберем эту особенность на двух примерах.
</p>
<p align="left">
&nbsp;
</p>
<p>
Ќапример, запись элемента справочника выполн€етс€ из встроенного €зыка внутри транзакции, открытой разработчиком. ¬ этом случае Ђпервойї (€вной) транзакцией будет транзакци€, инициированна€ разработчиком, а Ђвторойї (не€вной) будет транзакци€, открываема€ платформой при выполнении метода <font color="#3366ff">«аписать()</font> объекта справочника.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
явна€ транзакци€ открываетс€ разработчиком с помощью метода встроенного €зыка <font color="#3366ff">Ќачать“ранзакцию()</font>. ¬ отличие от версии 8.0 этот метод имеет параметр <font color="#3366ff">Ѕлокировкаƒанных</font>, который указывает какой режим управлени€ блокировками будет использоватьс€ в данной транзакции. ѕо умолчанию значение этого параметра равно <font color="#3366ff">јвтоматический</font>. ѕоэтому, если разработчик использует значение этого параметра по умолчанию, то независимо от того, какой режим установлен в свойствах записываемого справочника, его запись будет выполнена в автоматическом режиме (см. табл. 3, 1 и 3 строки).
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
≈сли же разработчик открывает транзакцию в управл€емом режиме, то он должен быть уверен в том, что дл€ записываемого в этой транзакции справочника, в свойствах метаданных указан управл€емый режим блокировок в транзакции. ¬ противном случае при записи элемента справочника будет вызвана исключительна€ ситуаци€ (см. табл. 3, 2 и 4 строки).
</p>
<p align="left">
–ассмотрим другой пример - интерактивное проведение документа, который выполн€ет движени€ по регистру накоплени€. ¬ этом случае Ђпервойї (не€вной) транзакцией будет транзакци€, открываема€ системой при записи документа, а Ђвторойї (также не€вной) будет транзакци€, открываема€ системой при записи набора записей регистра накоплени€.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
ƒалее все аналогично предыдущему примеру. ≈сли дл€ документа в метаданных установлен автоматический режим управлени€ блокировками, то независимо от того, какой режим установлен в метаданных дл€ регистра накоплени€, запись его набора записей всегда будет выполн€тьс€ в автоматическом режиме.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
≈сли же дл€ документа установлен управл€емый режим блокировок в транзакции, то дл€ регистра накоплени€ таже должен быть установлен управл€емый режим, иначе при проведении документа будет вызвана исключительна€ ситуаци€.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
»з этих примеров можно сделать следующий общий вывод. ≈сли, например, стоит задача повысить параллельность работы при проведении отдельного документа, не перевод€ при этом всю конфигурацию в управл€емый режим, то последовательность действий должна быть следующей:
</p>
<ul>
	<li>
	<div align="left">
	свойство конфигурации <font color="#3366ff">–ежим управлени€ блокировкой данных</font> необходимо установить в значение <font color="#3366ff">јвтоматический и управл€емый</font>;
	</div>
	</li>
	<li>
	<div align="left">
	свойство <font color="#3366ff">–ежим управлени€ блокировкой данных</font> объекта метаданных документ необходимо установить в значение <font color="#3366ff">”правл€емый</font>;
	</div>
	</li>
	<li>
	<div align="left">
	у всех регистров, по которым данный документ выполн€ет движени€, следует установить свойство <font color="#3366ff">–ежим управлени€ блокировкой данных</font> в значение <font color="#3366ff">”правл€емый</font>;
	</div>
	</li>
	<li>
	<div align="left">
	проанализировать процедуру проведени€ документа на предмет наличи€:
	</div>
	</li>
	<ul>
		<li>
		<div align="left">
		€вных вызовов транзакций
		</div>
		</li>
		<li>
		<div align="left">
		не€вных вызовов транзакций, которые выполн€ютс€ системой при модификации данных каких-либо объектов конфигурации
		</div>
		</li>
	</ul>
	<li>
	<div align="left">
	дл€ найденных €вных и не€вных вызовов транзакций обеспечить их выполнение в управл€емом режиме
	</div>
	</li>
	<ul>
		<li>
		<div align="left">
		дл€ €вных вызовов - параметр метода <font color="#3366ff">Ќачать“ранзакцию()</font>;
		</div>
		</li>
		<li>
		<div align="left">
		дл€ не€вных вызовов - свойство –ежим управлени€ блокировкой данных модифицируемого объекта конфигурации;
		</div>
		</li>
	</ul>
	<li>
	<div align="left">
	в теле процедуры проведени€ документа установить необходимые управл€емые блокировки (об этом см. далее).
	</div>
	</li>
</ul>
<h2 align="center">”становка управл€емых блокировок</h2>
<p align="left">
<br>
—редствами встроенного €зыка установка управл€емых блокировок внутри €вной или скрытой (не€вной) транзакции происходит с помощью специального объекта <font color="#3366ff">Ѕлокировкаƒанных</font>, описание доступных свойств и методов которого можно посмотреть в синтакс-помощнике в ветви ќбщие объекты (рис. 19).
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
&nbsp;
</p>
<div style="text-align: center">
<img src="./tran-isolation/ch03_019_example.PNG" alt="–ис. 3.19. Ќабор свойств и методов объекта ЂЅлокировкаƒанныхї доступных в —интакс-помощнике" title="–ис. 3.19. Ќабор свойств и методов объекта ЂЅлокировкаƒанныхї доступных в —интакс-помощнике" width="399" height="705">
</div>
<div style="text-align: center">
<p class="picnazv">
<span class="bold"></span><strong><font color="#993366">–ис. 19.</font></strong> Ќабор свойств и методов объекта ЂЅлокировкаƒанныхї доступных в —интакс-помощнике
</p>
<p class="picnazv" align="left">
&nbsp;
</p>
<p class="picnazv" align="left">
Ќовый экземпл€р данного объекта может быть создан с помощью одноименного конструктора и представл€ет собой коллекцию элементов блокировки данных. »значально эта коллекци€ пуста и задача разработчика состоит в добавлении в эту коллекцию некоторого количества элементов блокировки.
</p>
<p class="picnazv" align="left">
&nbsp;
</p>
<p class="picnazv" align="left">
ѕри добавлении нового элемента блокировки дл€ него необходимо указать <em>пространство блокировок</em>, которое будет блокировать данный элемент. ѕространства блокировок определены в платформе 1—:ѕредпри€ти€ 8.1 и соответствуют структуре прикладных объектов конфигурации. ƒопустимы следующие имена пространств блокировок и имена полей пространств блокировок (табл. 9):
</p>
<p class="picnazv" align="left">
&nbsp;
</p>
<p class="picnazv" align="left">
&nbsp;
</p>
<table border="1" cellspacing="2" cellpadding="5" width="678" style="height: 195px">
	<tbody>
		<tr>
			<td>&nbsp; »м€ пространства блокировок<span style="font-size: 10pt; font-family: &quot;Times New Roman&quot;"></span></td>
			<td>ѕол€ пространства блокировок</td>
		</tr>
		<tr>
			<td>&nbsp;—правочник.&lt;им€&gt;</td>
			<td>&nbsp;—сылка</td>
		</tr>
		<tr>
			<td>&nbsp;ƒокумент.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;ѕланќбмена.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;ѕлан—четов.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;Ѕизнеcѕроцесс.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;«адача.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;ѕлан¬идов–асчета.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;ѕлан¬идов’арактеристик.&lt;им€&gt;</td>
			<td>&nbsp; —сылка</td>
		</tr>
		<tr>
			<td>&nbsp;–егистр—ведений.&lt;им€&gt;.Ќабор«аписей - только дл€ регистра сведений, подчиненного регистратору</td>
			<td>&nbsp;–егистратор</td>
		</tr>
		<tr>
			<td>&nbsp;–егистр—ведений.&lt;им€&gt;</td>
			<td>&nbsp;ѕериод - если есть;<br>
			&lt;им€ измерени€&gt;<br>
			</td>
		</tr>
		<tr>
			<td>&nbsp;–егистрЌакоплени€.&lt;им€&gt;.Ќабор«аписей</td>
			<td>&nbsp;–егистратор</td>
		</tr>
		<tr>
			<td>&nbsp;–егистрЌакоплени€.&lt;им€&gt;</td>
			<td>ѕериод;<br>
			&lt;им€ измерени€&gt;</td>
		</tr>
		<tr>
			<td>&nbsp;–егистрЅухгалтерии.&lt;им€&gt;.Ќабор«аписей</td>
			<td>&nbsp;–егистратор</td>
		</tr>
		<tr>
			<td>&nbsp;–егистрЅухгалтерии.&lt;им€&gt;</td>
			<td>&nbsp;ѕериод;<br>
			&lt;вид движени€&gt; - значение системного перечислени€ ¬идƒвижени€Ѕухгалтерии;<br>
			—чет - об€зательное поле;<br>
			—убконто;<br>
			&lt;вид субконто&gt;;<br>
			&lt;им€ измерени€&gt;<br>
			</td>
		</tr>
		<tr>
			<td>&nbsp;–егистр–асчета.&lt;им€&gt;.Ќабор«аписей</td>
			<td>&nbsp;–егистратор</td>
		</tr>
		<tr>
			<td>&nbsp;–егистр–асчета.&lt;им€&gt;</td>
			<td>&nbsp;ѕериод–егистрации;<br>
			ѕериодƒействи€;<br>
			&lt;им€ измерени€&gt;<br>
			</td>
		</tr>
		<tr>
			<td>&nbsp;ѕерерасчет.&lt;им€&gt;.Ќабор«аписей</td>
			<td>&nbsp;ќбъектѕерерасчета</td>
		</tr>
		<tr>
			<td>&nbsp;ѕерерасчет.&lt;им€&gt;</td>
			<td>&nbsp;¬ид–асчета</td>
		</tr>
		<tr>
			<td>&nbsp;ѕоследовательность.&lt;им€&gt;.Ќабор«аписей</td>
			<td>&nbsp;–егистратор</td>
		</tr>
		<tr>
			<td>&nbsp;ѕоследовательность.&lt;им€&gt;</td>
			<td>&nbsp;&lt;им€ измерени€&gt;</td>
		</tr>
		<tr>
			<td>&nbsp; онстанта.&lt;им€&gt;</td>
			<td>
			<p>
			&nbsp;&nbsp;
			</p>
			</td>
		</tr>
	</tbody>
</table>
</div>
<div style="text-align: center">
&nbsp;
</div>
<div align="left" style="text-align: center">
<div align="left">
 ак видно из таблицы, дл€ <strong>объектных данных</strong> (справочник, документ и др.) определено единственное пространство блокировки - сам объект данных. ƒл€ <strong>необъектных данных</strong> (например, регистры) определено по два пространства блокировок, которые имеют разный логический смысл. <br>
</div>
<div align="left">
&nbsp;
</div>
<div align="left">
ѕространство блокировок с суффиксом <font color="#3366ff">Ќабор«аписей</font> используетс€ в тех случа€х, когда необходимо заблокировать сами записи данного объекта (например, при добавлении новых записей). <br>
</div>
<div align="left">
&nbsp;
</div>
<div align="left">
ѕространство блокировок без суффикса используетс€ тогда, анализируютс€ некоторые данные этого объекта (например, остатки регистра), или когда выполн€ютс€ какие-либо операции, привод€щие к изменению существующих данных объекта (например, восстановление границы последовательности).<br>
</div>
<div align="left">
&nbsp;
</div>
<div align="left">
ѕосле того, как элемент блокировки, соответствующий некоторому пространству блокировок, добавлен, следует установить дл€ этого элемента режим блокировки (раздел€ема€ или исключительна€) и определить значени€ полей блокировки, чтобы указать, какие же именно Ђзаписиї будут заблокированы (дл€ каждого пространства блокировок в платформе определены имена полей, значени€ которых могут задаватьс€ при установке тех или иных блокировок).<br>
</div>
&nbsp;
</div>
<p>
<font color="#ff0000"><strong>¬Ќ»ћјЌ»≈</strong></font>
</p>
<p>
&nbsp;
</p>
<blockquote>
	<p>
	—ледует понимать, что, в данном случае речь не идет о реальных запис€х базы данных. Ќесмотр€ на то, что управл€емые блокировки описываютс€ в терминах объектов метаданных и их полей, эти блокировки никак не св€заны с реальной структурой хранени€ данных 1—:ѕредпри€ти€ в —”Ѕƒ. Ёто всего лишь записи о том, что заблокировано Ђнечтої.
	</p>
	<p>
	&nbsp;
	</p>
	<p>
	»ногда можно провести аналогию между управл€емыми блокировками и реальными запис€ми —”Ѕƒ. Ќапример, дл€ объектных данных блокировка объекта с указанной ссылкой будет Ђсоответствоватьї блокировке всех записей, содержащих указанную ссылку, во всех таблицах этого объекта метаданных (в основной таблице и в таблицах его табличных частей).
	</p>
	<p>
	&nbsp;
	</p>
	<p>
	ќднако в других случа€х провести такую аналогию достаточно затруднительно, да и не нужно. Ќапример, блокировка регистра бухгалтерии с указанием значени€ вида субконто. ƒостаточно понимать, что накладыва€ такую блокировку мы запрещаем другим транзакци€м каким-либо образом измен€ть Ђзаписиї регистра бухгалтерии, у которых значение вида субконто равно указанному нами.  ак при этом данное условие Ђпроецируетс€ї на реальную структуру данных регистра бухгалтерии  - дл€ нас совершенно не важно.
	</p>
	<p>
	&nbsp;
	</p>
	<p>
	ѕри установке новых блокировок менеджер анализирует имеющиес€ блокировки. ≈сли оказываетс€, что Ђнечтої, что мы пытаемс€ заблокировать, уже заблокировано ранее, сравниваютс€ режимы существующей и новой блокировок. ≈сли режимы совместимы - нова€ блокировка устанавливаетс€. ≈сли режимы не совместимы - нова€ блокировка ожидает сн€ти€ существующей блокировки.
	</p>
	<p>
	&nbsp;
	</p>
</blockquote>
<p>
”слови€ необходимо ставить именно на те пол€, имена которых приведены в списке имен пространств блокировок. ƒл€ каждого пространства блокировок количество устанавливаемых условий не ограничено. ”слови€ могут быть заданы или на равенство значени€ пол€ какому-либо значению, или на вхождение значени€ пол€ в указанный диапазон.
</p>
<p>
&nbsp;
</p>
<p>
—уществует два способа задани€ условий на пол€ пространств блокировки:
</p>
<ul>
	<li>с помощью €вного задани€ имени пол€ и его значени€;</li>
	<li>с помощью указани€ источника данных, содержащего необходимые значени€</li>
</ul>
<p>
ѕри <strong>€вном</strong> задании имени пол€ и его значени€ необходимо использовать метод <font color="#3366ff">”становить«начение() </font>объекта <font color="#3366ff">ЁлементЅлокировкиƒанных</font>. ¬ этом случае им€ и значение указывают в качестве параметров метода, например так, как показано в листинге 1:
</p>
<p>
&nbsp;
</p>
<p>
<font color="#993366"><strong>Ћистинг 1.</strong></font> ѕример установки услови€ блокировки записей с помощью €вного указани€ имени пол€ и его значени€
</p>
<p>
&nbsp;
</p>
<div class="sampcont"><samp><span class="comment">// —оздать объект блокировка данных</span><br>Ѕлокировкаƒанных <span class="sign">=</span> <span class="word">Ќовый</span> Ѕлокировкаƒанных<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ƒобавить новый элемент блокировки, блокирующий Ђнечтої в данных регистра накоплени€ ќстатки номенклатуры </span><br>ЁлементЅлокировки <span class="sign">=</span> Ѕлокировкаƒанных<span class="sign">.</span>ƒобавить<span class="sign">(</span><span class="string">"–егистрЌакоплени€.ќстаткиЌоменклатуры"</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”становить режим блокировки - исключительный. ƒругие транзакции, устанавливающие управл€емые</span><br><span class="comment">// блокировки, не смогут даже начать чтение этих данных</span><br>ЁлементЅлокировки<span class="sign">.</span>–ежим <span class="sign">=</span> –ежимЅлокировкиƒанных<span class="sign">.</span>»сключительный<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”казать, что именно мы блокируем в данных регистра ќстатки номенклатуры - все Ђзаписиї, у которых </span><br><span class="comment">// значение измерени€ —клад равно значению, содержащемус€ в переменной —клад</span><br>ЁлементЅлокировки<span class="sign">.</span>”становить«начение<span class="sign">(</span><span class="string">"—клад"</span><span class="sign">,</span> —клад<span class="sign">)</span><span class="sign">;</span><br></samp></div>
<p>
&nbsp;
</p>
<p>
&nbsp;
</p>
<p>
ƒл€ значений типа <font color="#3366ff">ƒата </font>или <font color="#3366ff">„исло </font>в качестве значени€ может быть задан некоторый диапазон значений. ƒиапазон значений передаетс€ методу с помощью объекта встроенного €зыка - <font color="#3366ff">ƒиапазон</font>. ƒанный объект позвол€ет задать верхнюю и нижнюю границы диапазона, причем в диапазон включаютс€ и границы диапазона (листинг 2).
</p>
<p>
&nbsp;
</p>
<p>
<font color="#993366"><strong>Ћистинг 2.</strong></font> ѕример установки услови€ блокировки записей с помощью задани€ диапазона
</p>
<p>
&nbsp;
</p>
<div class="sampcont"><samp><span class="comment">// —оздать объект блокировка данных</span><br>Ѕлокировкаƒанных <span class="sign">=</span> <span class="word">Ќовый</span> Ѕлокировкаƒанных<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ƒобавить новый элемент блокировки, блокирующий Ђнечтої в данных регистра накоплени€ ѕродажи </span><br>ЁлементЅлокировки <span class="sign">=</span> Ѕлокировкаƒанных<span class="sign">.</span>ƒобавить<span class="sign">(</span><span class="string">"–егистрЌакоплени€.ѕродажи"</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”становить режим блокировки - раздел€емый. Ёти данные гарантировано не будут изменены другими</span><br><span class="comment">// транзакци€ми до окончани€ существующей транзакции</span><br>ЁлементЅлокировки<span class="sign">.</span>–ежим <span class="sign">=</span> –ежимЅлокировкиƒанных<span class="sign">.</span> –аздел€емый<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”казать, что именно мы блокируем в данных регистра ѕродажи - все Ђзаписиї, у которых </span><br><span class="comment">// значение измерени€  онтрагент равно значению, содержащемус€ в переменной  онтрагент</span><br>ЁлементЅлокировки<span class="sign">.</span>”становить«начение<span class="sign">(</span><span class="string">" онтрагент"</span><span class="sign">,</span>  онтрагент<span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// —оздать объект ƒиапазон, описывающих интервал от начала мес€ца, к которому принадлежит указанна€ дата, </span><br><span class="comment">// до указанной даты</span><br>ƒиапазон <span class="sign">=</span> <span class="word">Ќовый</span> ƒиапазон<span class="sign">(</span>Ќачалоћес€ца<span class="sign">(</span>ƒата<span class="sign">)</span><span class="sign">,</span> ƒата<span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”казать, что именно мы блокируем в данных регистра ѕродажи - все Ђзаписиї, у которых </span><br><span class="comment">// значение измерени€  онтрагент равно значению, содержащемус€ в переменной  онтрагент,</span><br><span class="comment">// и значение пол€ ѕериод содержитс€ в указанном диапазоне</span><br>ЁлементЅлокировки<span class="sign">.</span>”становить«начение<span class="sign">(</span><span class="string">"ѕериод"</span><span class="sign">,</span> ƒиапазон<span class="sign">)</span><span class="sign">;</span><br></samp></div>
<p>
&nbsp;
</p>
<p>
ѕри указании <strong>источника данных</strong> сначала необходимо задать свойство <font color="#3366ff">»сточникƒанных </font>объекта <font color="#3366ff">ЁлементЅлокировкиƒанных</font>, после чего, использу€ метод <font color="#3366ff">»спользовать»з»сточникаƒанных</font>(), настроить соответствие полей области блокировки данных пол€м источника данных (листинг 3).
</p>
<p>
&nbsp;
</p>
<p>
<font color="#993366"><strong>Ћистинг 3.</strong></font> ѕример установки услови€ блокировки записей с помощью источника данных
</p>
<p>
&nbsp;
</p>
<div class="sampcont"><samp><span class="comment">// —оздать объект блокировка данных</span><br>Ѕлокировкаƒанных <span class="sign">=</span> <span class="word">Ќовый</span> Ѕлокировкаƒанных<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ƒобавить новый элемент блокировки, блокирующий Ђнечтої в данных регистра накоплени€ ќстатки номенклатуры </span><br>ЁлементЅлокировки <span class="sign">=</span> Ѕлокировкаƒанных<span class="sign">.</span>ƒобавить<span class="sign">(</span><span class="string">"–егистрЌакоплени€.ќстаткиЌоменклатуры"</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”становить режим блокировки - исключительный. ƒругие транзакции, устанавливающие управл€емые</span><br><span class="comment">// блокировки, не смогут даже начать чтение этих данных</span><br>ЁлементЅлокировки<span class="sign">.</span>–ежим <span class="sign">=</span> –ежимЅлокировкиƒанных<span class="sign">.</span>»сключительный<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”казать, что именно мы блокируем в данных регистра ќстатки номенклатуры - все Ђзаписиї, у которых </span><br><span class="comment">// значение измерени€ —клад равно значению, содержащемус€ в переменной —клад</span><br>ЁлементЅлокировки<span class="sign">.</span>”становить«начение<span class="sign">(</span><span class="string">"—клад"</span><span class="sign">,</span> —клад<span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”казать источник данных, который содержит данные дл€ установки ограничений на другие пол€ этого</span><br><span class="comment">// элемента блокировки - в данном случае таблица значений —писокЌоменклатуры</span><br>ЁлементЅлокировки<span class="sign">.</span>»сточникƒанных <span class="sign">=</span> —писокЌоменклатуры<span class="sign">;</span>  <br></samp></div>
<div class="sampcont"><samp><span class="comment">// ”казать, что именно мы блокируем в данных регистра ќстатки номенклатуры - все Ђзаписиї, у которых </span><br><span class="comment">// значение измерени€ —клад равно значению, содержащемус€ в переменной —клад,</span><br><span class="comment">// и у которых значение измерени€ Ќоменклатура равно какому-либо значению, содержащемус€ в колонке</span><br><span class="comment">// Ќоменклатура указанного источника данных</span><br>ЁлементЅлокировки<span class="sign">.</span>»спользовать»з»сточникаƒанных<span class="sign">(</span><span class="string">"Ќоменклатура"</span><span class="sign">,</span> <span class="string">"Ќоменклатура"</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<p>
&nbsp;
</p>
<p>
¬ качестве источника данных можно указывать результат запроса, табличную часть, набор записей или таблицу значений. ѕри установке соответстви€ полей, именами полей источника будут €вл€тьс€ имена колонок результата запроса, имена реквизитов табличной части, имена измерений или имена колонок таблицы значений соответственно. «аметим, что объект <font color="#3366ff">ƒиапазон </font>также может €вл€тьс€ значением пол€ источника данных.
</p>
<p>
&nbsp;
</p>
<p>
ƒл€ установки всех созданных нами блокировок используетс€ метод объекта <font color="#3366ff">Ѕлокировкаƒанных </font>-  <font color="#3366ff">«аблокировать()</font>. Ќа рисунке 20 показано действие данного метода в случае использовани€ его внутри транзакции и вне ее.
</p>
<p>
&nbsp;
</p>
<p>
&nbsp;
</p>
<div style="text-align: center">
<img src="./tran-isolation/ch03_020.PNG" alt=" –ис. 3.20. —хема вызова метода Ђ«аблокировать()ї объекта ЂЅлокировкаƒанныхї" title="–ис. 3.20. —хема вызова метода Ђ«аблокировать()ї объекта ЂЅлокировкаƒанныхї" width="383" height="186">
</div>
<br>
<br>
&nbsp;
<p>
&nbsp;
</p>
<p align="center">
<font color="#993366"><strong>
–ис. 20.</strong></font> —хема вызова метода Ђ«аблокировать()ї объекта ЂЅлокировкаƒанныхї&nbsp;
</p>
<p align="center">
&nbsp;
</p>
<p>
 ак следует из рисунка, если этот метод выполн€етс€ внутри транзакции (€вной или не€вной), то блокировки устанавливаютс€ в момент вызова метода. ѕри окончании транзакции они будут сн€ты автоматически. ≈сли же метод <font color="#3366ff">«аблокировать()</font> выполн€етс€ вне транзакции, то блокировки установлены не будут.
</p>
<h2>–екомендации по модификации конфигураций при переходе к режиму управл€емых блокировок&nbsp;</h2>
<p>
ѕри переводе созданных ранее прикладных решений с версии 1—:ѕредпри€тие 8.0 на версию 1—:ѕредпри€тие 8.1 они требуют определенной степени доработки с точки зрени€ перехода к работе в режиме управл€емых блокировок. ƒадим р€д рекомендаций,  позвол€ющих определить последовательность действий разработчика в случае реализации вышеупом€нутого перевода:
</p>
<ul>
	<li> онвертируем конфигурацию из версии 8.0 в конфигурацию версии 8.1. –ежим управл€емых блокировок - автоматический.</li>
	<li>≈сли в процессе эксплуатации информационной базы возникают проблемы с параллельностью работы пользователей - например, часто стали по€вл€тьс€ сообщени€  о превышении времени ожидани€ блокировки  или о конфликтах взаимных блокировок, то составл€ем список документов, работа с которыми приводит к по€влению вышеупом€нутых проблем.</li>
	<li>ѕостепенно переводим конфигурацю в управл€емый режим. ”станавливаем свойство <font color="#3366ff">–ежим управлени€ блокировкой данных</font> всей конфигурации в целом в режим <font color="#3366ff">јвтоматический и управл€емый</font>.</li>
	<li>ƒл€ указанных в списке видов документов переводим свойство <font color="#3366ff">–ежим управлени€ блокировкой данных</font> в значение <font color="#3366ff">”правл€емый</font>. “акже в управл€емый режим переводим все регистры, по которым эти документы выполн€ют движени€ и все транзакции (€вные и не€вные), открываемые в процессе проведени€ документа.</li>
	<li>јнализируем тексты модулей каждого из указанных видов документов. Ќас интересуют операции чтени€ данных. ѕричем не все, а только те, где выполн€етс€ чтение некоторых данных, на основании которых затем модифицируютс€ эти же, или другие данные. ќчевидно, что читаемые данные в этом случае не должны быть изменены до окончани€ транзакции проведени€ документа, а значит перед чтением их требуетс€ заблокировать.</li>
	<li>”станавливаем управл€емые блокировки на найденные нами данные. ѕри этом раздел€ема€ блокировка устанавливаетс€ дл€ того, чтобы данные не были изменены другими транзакци€ми. »сключительна€ блокировка, помимо этого, обеспечивает запрет не только изменени€ этих данных, но даже их чтени€ другими транзакци€ми, устанавливающими управл€емые блокировки. ћожно сказать, что исключительна€ управл€ема€ блокировка €вл€етс€ средством борьбы с конфликтами блокировок (deadlock) и может использоватьс€ аналогично ключевому слову <font color="#3366ff">ƒЋя »«ћ≈Ќ≈Ќ»я</font> €зыка запросов в режиме автоматических блокировок.<br>
	</li>
</ul>
<p>
<strong>¬Ќ»ћјЌ»≈</strong>
</p>
<blockquote>
	¬ режиме управл€емых блокировок, за счет использовани€ другого уровн€ изол€ции транзакций —”Ѕƒ, конструкци€ <font color="#3366ff">ƒЋя »«ћ≈Ќ≈Ќ»я</font> €зыка запросов не работает. “аким образом, если в транзакции встречаютс€ запросы, содержащие эту конструкцию, перед их выполнением необходимо устанавливать исключительную управл€емую блокировку на читаемые данные. Ёто позволит в управл€емом режиме обеспечить поведение, аналогичное поведению в автоматическом режиме.<br>
	<p>
	&nbsp;
	</p>
	<p>
	—ледует помнить, что чтение данных другими транзакци€ми будет невозможно только в том случае, если в других транзакци€х устанавливаютс€ несовместимые управл€емые блокировки. ≈сли управл€емые блокировки в других транзакци€х не устанавливаютс€, то чтение будет возможно. Ёто аналогично тому, как конструкци€ <font color="#3366ff">ƒЋя »«ћ≈Ќ≈Ќ»я</font> преп€тствует чтению данных не любыми запросами, а только теми, которые тоже используют конструкцию <font color="#3366ff">ƒЋя »«ћ≈Ќ≈Ќ»я</font>.
	</p>
</blockquote>
<ul>
	<li>ѕри установке управл€емой блокировки необходимо стремитьс€, чтобы блокировка была установлена только на те записи, которые будут обработаны системой в результате отработки программного кода. ƒругими словами, при установке управл€емой блокировки желательно ставить услови€ на те же самые пол€ и по тем же самым значени€м, которые были указаны, например, в тексте запроса к данным информационной базы. Ќапример, см. текст листинга 4. <br>
	</li>
</ul>
<p>
¬ качестве примера, приведем фрагмент программного кода из текста обработчика <font color="#3366ff">ќбработкаѕроведени€()</font>, расположенного в модуле документа <font color="#3366ff">–асходна€Ќакладна€ </font>(листинг 4). ѕри выполнении указанного программного кода система, использу€ механизм запросов, сначала читает информацию из регистра накоплени€ <font color="#3366ff">ќстаткиЌоменклатуры</font>, а потом записывает в тот же самый регистр вновь сформированные данные. —огласно нашим рекомендаци€м, мы должны установить на записи регистра исключительную блокировку, запрещающую другим транзакци€м, в которых устанавливаюс€ управл€емые блокировки, не только запись, но и чтение, измен€емых при проведении накладной записей. ¬ данном случае исключительна€ блокировка нужна дл€ предотвращени€ возможного конфликта блокировок (deadlock).
</p>
<p>
&nbsp;
</p>
<p>
–азбира€ программный код, обратите внимание на соответствие условий при блокировке данных и в тексте запроса.
</p>
<p>
&nbsp;
</p>
<p>
<font color="#993366"><strong>Ћистинг 4.</strong></font> ѕример установки исключительной блокировки при проведении документа Ђ–асходна€Ќакладна€ї
</p>
<p>
&nbsp;
</p>
<div class="sampcont"><samp>Ѕлокировкаƒанных <span class="sign">=</span> <span class="word">Ќовый</span> Ѕлокировкаƒанных<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// ¬ыбрать пространство блокировок –егистрЌакоплени€.ќстаткиЌоменклатуры, т.к. мы собираемс€ анализировать</span><br><span class="comment">// остатки регистра</span><br>ЁлементЅлокировки <span class="sign">=</span> Ѕлокировкаƒанных<span class="sign">.</span>ƒобавить<span class="sign">(</span><span class="string">"–егистрЌакоплени€.ќстаткиЌоменклатуры"</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp>ЁлементЅлокировки<span class="sign">.</span>–ежим <span class="sign">=</span> –ежимЅлокировкиƒанных<span class="sign">.</span>»сключительный<span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// «аблокировать Ђзаписиї с указанным значением измерени€ склад, т.к. в запросе есть следующее условие:</span><br><span class="comment">// ... » —клад = &amp;—клад) ...</span><br>ЁлементЅлокировки<span class="sign">.</span>”становить«начение<span class="sign">(</span><span class="string">"—клад"</span><span class="sign">,</span> —клад<span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp><span class="comment">// «аблокировать Ђзаписиї со значени€ми номенклатуры из табличной части, соответствующими условию</span><br><span class="comment">// ...  –асходна€Ќакладна€—писокЌоменклатуры.Ќоменклатура.”слуга = Ћќ∆№ ...</span><br><span class="comment">// эти данные необходимо получить запросом к табличной части</span><br>«апрос»сточник <span class="sign">=</span> <span class="word">Ќовый</span> «апрос<span class="sign">;</span><br>«апрос»сточник<span class="sign">.</span>“екст <span class="sign">=</span> <span class="string">"¬џЅ–ј“№ –ј«Ћ»„Ќџ≈<br>|	–асходна€Ќакладна€—писокЌоменклатуры.Ќоменклатура  ј  Ќоменклатура<br>|»«<br>|	ƒокумент.–асходна€Ќакладна€.—писокЌоменклатуры  ј  –асходна€Ќакладна€—писокЌоменклатуры<br>|√ƒ≈<br>|	–асходна€Ќакладна€—писокЌоменклатуры.—сылка = &amp;—сылка<br>|	<span class="word">»</span> –асходна€Ќакладна€—писокЌоменклатуры.Ќоменклатура.”слуга = Ћќ∆№"</span><span class="sign">;</span><br>«апрос»сточник<span class="sign">.</span>”становитьѕараметр<span class="sign">(</span><span class="string">"—сылка"</span><span class="sign">,</span> —сылка<span class="sign">)</span><span class="sign">;</span>					   <br>»сточникЌоменклатуры <span class="sign">=</span> «апрос»сточник<span class="sign">.</span><span class="word">¬ыполнить</span><span class="sign">(</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp>ЁлементЅлокировки<span class="sign">.</span>»сточникƒанных <span class="sign">=</span> »сточникЌоменклатуры<span class="sign">;</span>  <br>ЁлементЅлокировки<span class="sign">.</span>»спользовать»з»сточникаƒанных<span class="sign">(</span><span class="string">"Ќоменклатура"</span><span class="sign">,</span> <span class="string">"Ќоменклатура"</span><span class="sign">)</span><span class="sign">;</span><br>Ѕлокировкаƒанных<span class="sign">.</span>«аблокировать<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<div class="sampcont"><samp>«апрос <span class="sign">=</span> <span class="word">Ќовый</span> «апрос<span class="sign">;</span><br>«апрос<span class="sign">.</span>“екст <span class="sign">=</span> "¬џЅ–ј“№<br><span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span><br>|	Ћ≈¬ќ≈ —ќ≈ƒ»Ќ≈Ќ»≈ –егистрЌакоплени€<span class="sign">.</span>ќстаткиЌоменклатуры<span class="sign">.</span>ќстатки<span class="sign">(</span><span class="sign">&amp;</span>ћом¬ремени<span class="sign">,</span><br>|					Ќоменклатура ¬ <span class="sign">(</span>¬џЅ–ј“№ –ј«Ћ»„Ќџ≈<br>|										–асходна€Ќакладна€—писокЌоменклатуры<span class="sign">.</span>Ќоменклатура<br>|									<span class="word">»«</span><br>|										ƒокумент<span class="sign">.</span>–асходна€Ќакладна€<span class="sign">.</span>—писокЌоменклатуры  ј                         |																	–асходна€Ќакладна€—писокЌоменклатуры<br>|									√ƒ≈<br>|										–асходна€Ќакладна€—писокЌоменклатуры<span class="sign">.</span>—сылка <span class="sign">=</span> <span class="sign">&amp;</span>—сылка<br>|										<span class="word">»</span> –асходна€Ќакладна€—писокЌоменклатуры<span class="sign">.</span>Ќоменклатура<span class="sign">.</span>”слуга <span class="sign">=</span> <span class="word">Ћќ∆№</span><span class="sign">)</span><br>|										<span class="word">»</span> —клад <span class="sign">=</span> <span class="sign">&amp;</span>—клад<span class="sign">)</span>  ј  ќстаткиЌоменклатурыќстатки<br></samp></div>
<div class="sampcont"><samp><span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span>           <br>|"<span class="sign">;</span><br><span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span>           <br><span class="word">ѕока</span> ¬ыборка<span class="sign">.</span>—ледующий<span class="sign">(</span><span class="sign">)</span> <span class="word">÷икл</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span> <span class="sign">.</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="comment">// регистр ќстаткиЌоменклатуры –асход</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение <span class="sign">=</span> ƒвижени€<span class="sign">.</span>ќстаткиЌоменклатуры<span class="sign">.</span>ƒобавить<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение<span class="sign">.</span>¬идƒвижени€ <span class="sign">=</span> ¬идƒвижени€Ќакоплени€<span class="sign">.</span>–асход<span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение<span class="sign">.</span>ѕериод <span class="sign">=</span> ƒата<span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение<span class="sign">.</span>Ќоменклатура <span class="sign">=</span> ¬ыборка<span class="sign">.</span>Ќоменклатура<span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение<span class="sign">.</span>—клад <span class="sign">=</span> —клад<span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение<span class="sign">.</span> оличество <span class="sign">=</span> ¬ыборка<span class="sign">.</span> оличество<span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>—умма—писани€ <span class="sign">=</span> <span class="sign">?</span><span class="sign">(</span>¬ыборка<span class="sign">.</span> оличествоќстаток <span class="sign">=</span> ¬ыборка<span class="sign">.</span> оличество<span class="sign">,</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>¬ыборка<span class="sign">.</span>—уммаќстаток<span class="sign">,</span> <br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>¬ыборка<span class="sign">.</span>—уммаќстаток / ¬ыборка<span class="sign">.</span> оличествоќстаток <span class="sign">*</span> ¬ыборка<span class="sign">.</span> оличество<span class="sign">)</span><span class="sign">;</span><br><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span><span class="sign">&nbsp;</span>ƒвижение<span class="sign">.</span>—умма <span class="sign">=</span> —умма—писани€<span class="sign">;</span><br><span class="word"> онец÷икла</span><span class="sign">;</span><br>ƒвижени€<span class="sign">.</span>ќстаткиЌоменклатуры<span class="sign">.</span>«аписать<span class="sign">(</span><span class="sign">)</span><span class="sign">;</span><br></samp></div>
<br>
<br>
<p>
ќбратите внимание, что при создании источника данных дл€ установки блокировок по номенклатуре мы использовали результат запроса к табличной части.  азалось бы, в качестве источника данных можно было просто использовать табличную часть (<font color="#3366ff">ЁлементЅлокировки.»сточникƒанных = —писокЌоменклатуры</font>), но при этом мы бы заблокировали лишние данные, ведь нас интересует только та номенклатура из табличной части, котора€ не €вл€етс€ услугой (<font color="#3366ff">–асходна€Ќакладна€—писокЌоменклатуры.Ќоменклатура.”слуга = Ћќ∆№)</font>. Ётот момент как раз хорошо иллюстрирует тот факт, что к установке управл€емых блокировок нужно относитьс€ внимательно и не устанавливать Ђплохихї (избыточных) блокировок.
</p>
<p>
&nbsp;
</p>
<p>
“еперь расмотрим подробнее вопрос необходимости установки именно исключительной управл€емой блокировки.
</p>
<p>
&nbsp;
</p>
<p>
<strong>≈сли бы мы не использовали никакой управл€емой блокировки</strong>, то наш запрос, читающий данные, начал бы выполн€тьс€ в любом случае. ѕосле его окончани€ (еще до окончани€ транзакции!) —”Ѕƒ сн€ла бы блокировку с прочитанных данных. Ёто значит, что друга€ транзакци€ тут же могла бы эти данные изменить (таковы особенности блокировок на уровне изол€ции Read Committed). ѕоэтому управл€ема€ блокировка необходима дл€ того, чтобы гарантировать, что прочитанные данные не будут изменены до окончани€ нашей транзакции.
</p>
<p>
&nbsp;
</p>
<p>
 аким образом управл€ема€ блокировка преп€тствует изменению данных? ¬ результате выполнени€ метода <font color="#3366ff">«аблокировать()</font> в менеджере транзакционных блокировок по€вл€ютс€ записи о тех данных, которые мы блокируем (естественно, если они не конфликтуют с существующими блокировками) (рис. 21).
</p>
<p align="center">
<img src="./tran-isolation/ch03_021.PNG" alt="–ис. 3.21. ”становка управл€емых блокировок" title="–ис. 3.21. ”становка управл€емых блокировок" width="413" height="237">
</p>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 21.</span></strong></font> ”становка управл€емых
блокировок
</p>
<p>
&nbsp;
</p>
<p>
ѕри любой попытке модификации данных информационной базы система автоматически будет пытатьс€ установить исключительные управл€емые блокировки дл€ модифицируемых данных. “аким образом, если окажетс€, что друга€ транзакци€ пытаетс€ модифицировать те данные, которые мы уже заблокировали, менеджер транзакционных блокировок не даст ей установить нужные блокировки, т.к. исключительна€ блокировка, которую пытаетс€ установить друга€ транзакци€, не совместима с нашей раздел€емой блокировкой (рис. 22).
</p>
<p>
&nbsp;
</p>
<p>
&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_022.PNG" alt="–ис. 3.22. Ќевозможно установить исключительную блокировку на номенклатуру 2" title="–ис. 3.22. Ќевозможно установить исключительную блокировку на номенклатуру 2" width="676" height="250">
</p>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 22.</span></strong></font> Ќевозможно установить
исключительную блокировку на номенклатуру 2
</p>
<p>
&nbsp;
</p>
<p>
«начит система не сможет изменить данные, заблокированные нами до тех пор, пока наша транзакци€ не закончитс€ и наша блокировка не будет сн€та автоматически при завершении транзакции (рис. 23).
</p>
<p>
&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_023.PNG" alt="–ис. 3.23. »сполнение кода продолжаетс€ после завершени€ нашей транзакции" title="–ис. 3.23. »сполнение кода продолжаетс€ после завершени€ нашей транзакции" width="632" height="288">
</p>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 23.</span></strong></font> »сполнение кода
продолжаетс€ после завершени€ нашей транзакции
</p>
<p>
&nbsp;
</p>
<p>
≈сли бы мы использовали <strong>только раздел€емую управл€емую блокировку</strong>, то мы могли бы получить конфликт блокировок (deadlock) с другой транзакцией.
</p>
<p>
&nbsp;
</p>
<p>
Ќапример, наша и друга€ транзакци€ начали читать остатки из регистра <font color="#3366ff">ќстатки номенклатуры</font>. —писки номенклатуры, дл€ которых читаютс€ остатки в одной и другой транзакции, имеют одинаковые элементы. ѕри этом система в нашей и в другой транзакции устанавливает раздел€емую блокировку на читаемые данные. ƒве раздел€емые блокировки на один и тот же ресурс (Ђпересекающиес€ї элементы номенклатуры) совместимы друг с другом (рис. 24).
</p>
<div align="center">
<img src="./tran-isolation/ch03_024.PNG" alt="–ис. 3.24. –аздел€емые блокировки совместимы друг с другом" title="–ис. 3.24. –аздел€емые блокировки совместимы друг с другом" width="714" height="294">
</div>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 24.</span></strong></font> –аздел€емые блокировки
совместимы друг с другом
</p>
<p>
&nbsp;
</p>
<p>
«атем мы закончили читать данные и хотим записать в этот регистр Ђновые остаткиї дл€ прочитанной номенклатуры. ћы не можем это сделать, т.к. дл€ этого система должна установить исключительную блокировку на записываемые данные, но этому мешает раздел€ема€ блокировка, установленна€ на часть этих данных другой транзакцией. Ќаша транзакци€ становитс€ в очередь, ожида€ сн€ти€ раздел€емой блокировки, установленной другой транзакцией (рис. 25).&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_025.PNG" alt="–ис. 3.25. Ќаша транзакци€ не может установить исключительную блокировку на номенклатуру 2" title="–ис. 3.25. Ќаша транзакци€ не может установить исключительную блокировку на номенклатуру 2" width="714" height="377">
</p>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 25.</span></strong></font> Ќаша транзакци€ не может
установить исключительную блокировку на номенклатуру 2
</p>
<p>
&nbsp;
</p>
<p>
¬ это врем€ друга€ транзакци€ также закончила чтение данных и хочет записать в этот регистр Ђновые остаткиї дл€ прочитанной номенклатуры. ќна не может это сделать, т.к. дл€ этого система должна установить исключительную блокировку на записываемые данные, но этому мешает раздел€ема€ блокировка, установленна€ на часть этих данных нашей транзакцией. ƒруга€ транзакци€ становитс€ в очередь, ожида€ сн€ти€ раздел€емой блокировки, установленной нашей транзакцией транзакцией (рис. 26).&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_026.PNG" alt="–ис. 3.26.  онфликт блокировок: друга€ транзакци€ также не может установить блокировку на номенклатуру 2" title="–ис. 3.26.  онфликт блокировок: друга€ транзакци€ также не может установить блокировку на номенклатуру 2" width="713" height="412">
</p>
<p align="center">
<font color="#993366"><strong>–ис. 26.</strong></font>  онфликт блокировок: друга€ транзакци€ также не может установить блокировку на номенклатуру 2&nbsp;
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬ результате получаетс€ конфликт блокировок (deadlock), который может быть разрешен только принудительной отменой одной из транзакций.
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
ѕоэтому в данном случае необходима исключительна€ блокировка (рис. 27).
</p>
<div align="center">
<img src="./tran-isolation/ch03_027.PNG" alt="–ис. 3.27. ”становка исключительных блокировок" title="–ис. 3.27. ”становка исключительных блокировок" width="439" height="176">
</div>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 27.</span></strong></font> ”становка исключительных
блокировок
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬ этом случае, когда друга€ транзакци€, использующа€ управл€емые блокировки, попытаетс€ начать чтение данных, которые мы заблокировали, она не сможет этого сделать. ћенеджер тразакционных блокировок не даст ей установить никакую управл€емую блокировку (ни раздел€емую, ни исключительную) на наши данные, т.к. они не совместимы с нашей исключительной блокировкой (рис. 28).
</p>
<p align="left">
&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_028.PNG" alt="–ис. 3.28. ƒруга€ транзакци€ не может установить блокировку на номенклатуру 2" title="–ис. 3.28. ƒруга€ транзакци€ не может установить блокировку на номенклатуру 2" width="734" height="260">
</p>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 28.</span></strong></font> ƒруга€ транзакци€ не может
установить блокировку на номенклатуру 2
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
¬ результате исполнение кода в другой транзакции будет остановлено и система будет ожидать сн€ти€ нашей исключительной блокировки. ј наша транзакци€ сможет завершитс€, т.к. друга€ транзакци€ не имеет возможности заблокировать те записи, которые понадоб€тс€ нам дл€ модификации (рис. 29).
</p>
<p align="left">
&nbsp;
</p>
<p align="center">
<img src="./tran-isolation/ch03_029.PNG" alt="–ис. 3.29. Ќаша транзакци€ успешно завершаетс€" title="–ис. 3.29. Ќаша транзакци€ успешно завершаетс€" width="778" height="338">
</p>
<p align="center">
&nbsp;
</p>
<p class="picnazv" align="center">
<font color="#993366"><strong><span class="bold">–ис. 29.</span></strong></font> Ќаша транзакци€ успешно завершаетс€
</p>
<p align="left">
&nbsp;
</p>
<p align="left">
&nbsp;
</p>

</div>

<div class="bord">
	<b>ƒата создани€:</b> 30.08.2007 13:22<br>
</div>

<script>formatMess();</script>







	</td>
</tr>
</tbody></table>






</body><style type="text/css">embed[type*="application/x-shockwave-flash"],embed[src*=".swf"],object[type*="application/x-shockwave-flash"],object[codetype*="application/x-shockwave-flash"],object[src*=".swf"],object[codebase*="swflash.cab"],object[classid*="D27CDB6E-AE6D-11cf-96B8-444553540000"],object[classid*="d27cdb6e-ae6d-11cf-96b8-444553540000"],object[classid*="D27CDB6E-AE6D-11cf-96B8-444553540000"]{	display: none !important;}</style></html>
